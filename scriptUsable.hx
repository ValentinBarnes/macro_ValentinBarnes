# Avizo Project 940
# Avizo
# Generated by Avizo 9.4.0


#global variables. See namespace documentation on the tcl wiki
#Those variables are only flags, having a value equal to 0 or 1
#This structure is used to reduce the number of arguments of the functions
namespace eval flags {
    variable isEllipsoidFit 0
	variable isUseNucleusForMembrane 0
	variable isMembrane 0
	variable isNucleus 0
	variable isPaxilin 0
	variable isScaffold 0
}


# ##### Major Functions #############

#Function called to process the membrane (report p 40)
proc membrane {imageStackPath cellFolderOutputPath fileFormat referenceImage membraneThreshold structuringElementSize shapeAnalysisCSVFile voxelSizeX voxelSizeY voxelSizeZ} {

#Check if a processed nucleus stack is still in the project view, if it is not the case then the variable is an empty string
set imageStackNucleusProcessed [all -visible]

#If the the option isUseNucleusForMembrane has been selected and the processed nucleus stack is in the project view (imageStackNucleusProcessed is not an empty string).
if {$flags::isUseNucleusForMembrane && $imageStackNucleusProcessed != ""} {
	#Autorize the removal of the processed nucleus label (label is the name of the stack in the Avizo project view) from the project view.
	"$imageStackNucleusProcessed" setNoRemove 0
	"$imageStackNucleusProcessed" setNoRemoveAll 0
}

#Extract only the stack name from the image stack path.
set imageStackName [file tail [file rootname $imageStackPath]]
#Extract the extension of the image stack (supposed to be ".tif" or ".TIF").
set extension [file extension $imageStackPath]

#Try to load the reference image, if a problem occurs stop the processing of the stack and remove all the modules in the project view in anticipation of the next call of a processing function (membrane, nucleus, scaffold or paxilin).
if {[catch {[load -tif +mode 100 +box 0 1 0 1 0 1 $referenceImage] setLabel "referenceImage"}]} {
	remove -all
	return
}
#Set the correct voxel size of the reference stack
resample referenceImage $voxelSizeX $voxelSizeY $voxelSizeZ

#Try to load the membrane stack, if a problem occurs, stop the processing of the stack and remove all the modules in the project view in anticipation of the next call of a processing function (membrane, nucleus, scaffold or paxilin).
if {[catch {[load -tif +mode 100 +box 0 104.312 0 104.104 0 50 $imageStackPath] setLabel "$imageStackName"}]} {
	remove -all
	return
}
#Set the correct voxel size of the stack
resample $imageStackName $voxelSizeX $voxelSizeY $voxelSizeZ

#pre-processing, label (name of the stack in the Avizo project view) of the pre-processed stack is stored in the variable.
set imageStackContrastMatching [contrastMatching $imageStackName referenceImage]

if 1 {
#Grayscale normalization to change the minimum and maximum intensity of the stack to 0 and 255
#Using this module may actually be a bad idea. The result may be better without it.
set hideNewModules 0
create normalize "Normalize Grayscale"
"Normalize Grayscale" setIconPosition 593 219
"Normalize Grayscale" setVar "CustomHelp" {normalize.html}
"Normalize Grayscale" interpretation setValue 0
"Normalize Grayscale" outputLocation setIndex 0 0
"Normalize Grayscale" inputImage connect "$imageStackContrastMatching"
"Normalize Grayscale" fire
"Normalize Grayscale" rangeMode setIndex 0 0
"Normalize Grayscale" fire
"Normalize Grayscale" inputRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale" inputRange setValue 0 0
"Normalize Grayscale" inputRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale" inputRange setValue 1 255
"Normalize Grayscale" fire
"Normalize Grayscale" percentage setMinMax 0 0 3.40282346638529e+038
"Normalize Grayscale" percentage setValue 0 2
"Normalize Grayscale" percentage setMinMax 1 0 3.40282346638529e+038
"Normalize Grayscale" percentage setValue 1 98
"Normalize Grayscale" fire
"Normalize Grayscale" outputRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale" outputRange setValue 0 0
"Normalize Grayscale" outputRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale" outputRange setValue 1 255
"Normalize Grayscale" fire
"Normalize Grayscale" applyTransformToResult 1
"Normalize Grayscale" fire
"Normalize Grayscale" setViewerMask 16383
"Normalize Grayscale" setPickable 1
"Normalize Grayscale" doIt snap 0 1

set hideNewModules 0
[ {Normalize Grayscale} create ImgOut ] setLabel "$imageStackName.corrected"
"$imageStackName.corrected" setIconPosition 519 260
"$imageStackName.corrected" master connect "Normalize Grayscale" "ImgOut" 0
"$imageStackName.corrected" sharedColormap disconnect
"$imageStackName.corrected" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.corrected" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.corrected" sharedColormap activateLocalRange 1
"$imageStackName.corrected" sharedColormap setLocalMinMax 0.000000 1.000000
"$imageStackName.corrected" sharedColormap enableAlpha 1
"$imageStackName.corrected" sharedColormap enableAlphaToggle 1
"$imageStackName.corrected" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.corrected" sharedColormap setColorbarMinMax 0 255
"$imageStackName.corrected" fire
"$imageStackName.corrected" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.corrected" fire
"$imageStackName.corrected" setViewerMask 16383

#Hysteresis Thresholding
#Creation and setup of the module
set hideNewModules 0
create hysteresis "Hysteresis Thresholding"
"Hysteresis Thresholding" setIconPosition 279 183
"Hysteresis Thresholding" setVar "CustomHelp" {hysteresis.html}
"Hysteresis Thresholding" interpretation setValue 0
"Hysteresis Thresholding" outputLocation setIndex 0 0
#Set the label to connect to the module 
"Hysteresis Thresholding" inputImage connect "$imageStackName.corrected"
"Hysteresis Thresholding" thresholds setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
#Set the lower threshold lambda1
"Hysteresis Thresholding" thresholds setValue 0 $membraneThreshold
"Hysteresis Thresholding" thresholds setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
#Set the upper threshold lambda2
"Hysteresis Thresholding" thresholds setValue 1 78
"Hysteresis Thresholding" length setMinMax 0 0 2147483648
"Hysteresis Thresholding" length setValue 0 0
"Hysteresis Thresholding" applyTransformToResult 1
#Apply the module to the stack
"Hysteresis Thresholding" fire
"Hysteresis Thresholding" setViewerMask 16383
"Hysteresis Thresholding" setPickable 1
"Hysteresis Thresholding" doIt snap 0 1

#Create the result of the thresholding in the project view, as a new label
set hideNewModules 0
[ {Hysteresis Thresholding} create ImgOutBin ] setLabel "$imageStackName.binary"
"$imageStackName.binary" setIconPosition 36 188
"$imageStackName.binary" master connect "Hysteresis Thresholding" "ImgOutBin" 0
"$imageStackName.binary" sharedColormap connect "labels.am"
"$imageStackName.binary" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.binary" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.binary" sharedColormap activateLocalRange 1
"$imageStackName.binary" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.binary" sharedColormap enableAlpha 1
"$imageStackName.binary" sharedColormap enableAlphaToggle 1
"$imageStackName.binary" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.binary" sharedColormap setColorbarMinMax 1 8
"$imageStackName.binary" fire
"$imageStackName.binary" primary setIndex 0 0
"$imageStackName.binary" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.binary" fire
"$imageStackName.binary" setViewerMask 16383

#if isUseNucleusForMembrane is selected and the processed nucleus label is in the project view,
#Combine the segmented membrane label and the processed nucleus label via a boolean OR module.
if {$flags::isUseNucleusForMembrane && $imageStackNucleusProcessed != ""} {
	set hideNewModules 0
	create logical_orimage "OR Image 405"
	"OR Image 405" setIconPosition 83 865
	"OR Image 405" setVar "CustomHelp" {logical_orimage.html}
	"OR Image 405" interpretation setValue 0
	"OR Image 405" outputLocation setIndex 0 0
	#Connect OR module to the two labels.
	"OR Image 405" inputImage1 connect "$imageStackName.binary"
	"OR Image 405" inputImage2 connect "$imageStackNucleusProcessed"
	"OR Image 405" applyTransformToResult 1
	"OR Image 405" fire
	"OR Image 405" setViewerMask 16383
	"OR Image 405" setPickable 1
	"OR Image 405" doIt snap 0 1
	
	#Create result of the OR module.
	set hideNewModules 0
	[ {OR Image 405} create ImgOut ] setLabel "$imageStackName.or"
	"$imageStackName.or" setIconPosition 20 901
	"$imageStackName.or" master connect "OR Image 405" "ImgOut" 0
	"$imageStackName.or" sharedColormap connect "labels.am"
	"$imageStackName.or" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$imageStackName.or" sharedColormap setDefaultAlpha 0.500000
	"$imageStackName.or" sharedColormap activateLocalRange 1
	"$imageStackName.or" sharedColormap setLocalMinMax 1.000000 8.000000
	"$imageStackName.or" sharedColormap enableAlpha 1
	"$imageStackName.or" sharedColormap enableAlphaToggle 1
	"$imageStackName.or" sharedColormap setAutoAdjustRangeMode 1
	"$imageStackName.or" sharedColormap setColorbarMinMax 1 8
	"$imageStackName.or" fire
	"$imageStackName.or" primary setIndex 0 0
	"$imageStackName.or" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$imageStackName.or" fire
	"$imageStackName.or" setViewerMask 16383
	
	#Change the label of the result.
	"$imageStackName.or" setLabel "$imageStackName.segmented"
#Else, the segmented membrane label is not combined with anything, and 
} else {
	"$imageStackName.binary" setLabel "$imageStackName.segmented"
}
}

#Post-processing, label of the post processed stack is stored in the variable.
set imageStackPostProcessed [postProcessing "$imageStackName.segmented" "closing" $structuringElementSize]

#Extract parameters from the processed label.
set labelAnalysisResults [labelAnalysis $imageStackPostProcessed [file tail $cellFolderOutputPath]]
#Get the list of parameters extracted from the Avizo table
set parametersForShapeAnalysis [lindex $labelAnalysisResults 0]
#Get the label of the processed stack
set imageStackProcessed [lindex $labelAnalysisResults 1]
#Get the label of the Avizo table
set imageStackAnalysisFilter [lindex $labelAnalysisResults 2]

#Create a boundary stack, get its label in the variable
set imageStackBoundary [getBoundary $imageStackProcessed]

#Call a function loading in the project the stack processed by ImageJ if it exists
if {[isDirectoryOrFileExist [file join [file dirname [file dirname $imageStackPath]] segmented $imageStackName\SEG$extension]]} {
	getTBSegmentation $imageStackName $imageStackBoundary [file dirname [file dirname $imageStackPath]] $extension $voxelSizeX $voxelSizeY $voxelSizeZ
}

#Save the stacks, tables, project files in the output structure
saveFiles $imageStackName $imageStackBoundary $imageStackProcessed $imageStackAnalysisFilter $cellFolderOutputPath $extension $fileFormat 

#Prevent the following labels from being removed from the project view
"$imageStackName" setNoRemove 1
"$imageStackName" setNoRemoveAll 1
"$imageStackProcessed" setNoRemove 1
"$imageStackProcessed" setNoRemoveAll 1
"$imageStackBoundary" setNoRemove 1
"$imageStackBoundary" setNoRemoveAll 1

#Clean the project view
remove -all

#Save the remaining labels in a project file in the verification folder
verificationProject $imageStackName $imageStackBoundary $imageStackProcessed $cellFolderOutputPath

#Autorize again the removal of the following labels
"$imageStackName" setNoRemove 0
"$imageStackName" setNoRemoveAll 0
"$imageStackBoundary" setNoRemove 0
"$imageStackBoundary" setNoRemoveAll 0

remove -all

#If the user selected ellipsoid fit
if {$flags::isEllipsoidFit} {
	#Get the list of parameters resulting from the ellipsoid fit
	set radiusList [ellipsoidFit $imageStackProcessed $cellFolderOutputPath $voxelSizeX $voxelSizeY $voxelSizeZ]
	#if the list doesn't contain "problem with matlab"
	if {$radiusList != "problem with matlab"} {
		#Get the parameters from radiusList
		#Radiuses of the ellipsoid
		set a [lindex $radiusList 0]
		set b [lindex $radiusList 1]
		set c [lindex $radiusList 2]
		#Coordinates of the center of the ellipsoid
		set xc [lindex $radiusList 3]
		set yc [lindex $radiusList 4]
		set zc [lindex $radiusList 5]
		#Angles of the ellipsoid
		set alpha [lindex $radiusList 6]
		set beta [lindex $radiusList 7]
		set gamma [lindex $radiusList 8]
		#Sphericity of the ellipsoid
		set ellipsoidSphericity [lindex $radiusList 9]
		#Volume of the ellipsoid
		set ellipsoidVolume [lindex $radiusList 10]
		echo $ellipsoidVolume
		#Get the volume of the processed stack from the list parametersForShapeAnalysis
		set stackVolume [lindex $parametersForShapeAnalysis 1]
		echo $stackVolume
		#Calculate the relation between the processed stack volume and the ellipsoid volume
		set extraVolume [expr (($stackVolume/$ellipsoidVolume)-1)*100]
		#Append the ellipsoid parameters in the list parametersForShapeAnalysis
		lappend parametersForShapeAnalysis $a $b $c $xc $yc $zc $alpha $beta $gamma $ellipsoidSphericity $ellipsoidVolume $extraVolume
		#Append the list of parameters in the global CSV file for membrane stacks
		writeCSVFile $shapeAnalysisCSVFile $parametersForShapeAnalysis "," "append"
	#if the list contains "problem with matlab"
	} else {
		#Append the list of parameters in the global CSV file for membrane stacks without ellipsoid parameters
		writeCSVFile $shapeAnalysisCSVFile $parametersForShapeAnalysis "," "append"
	}
#If the user didn't select ellipsoid fit
} else {
#Append the list of parameters in the global CSV file for membrane stacks without ellipsoid parameters
	writeCSVFile $shapeAnalysisCSVFile $parametersForShapeAnalysis "," "append"
}

"$imageStackProcessed" setNoRemove 0
"$imageStackProcessed" setNoRemoveAll 0

remove -all
}

#Function called to process the paxilin
#This function is not commented and need to be modified
proc paxilin {imageStackPath cellFolderOutputPath fileFormat voxelSizeX voxelSizeY voxelSizeZ} {
set imageStackName [file tail [file rootname $imageStackPath]]
set extension [file extension $imageStackPath]

if {[catch {[load -tif +mode 100 +box 0 104.312 0 104.104 0 50 $imageStackPath] setLabel "$imageStackName"}]} {
	remove -all
	return
}
resample $imageStackName $voxelSizeX $voxelSizeY $voxelSizeZ

if 1 {
set hideNewModules 0
create normalize "Normalize Grayscale 2"
"Normalize Grayscale 2" setIconPosition 46 185
"Normalize Grayscale 2" setVar "CustomHelp" {normalize.html}
"Normalize Grayscale 2" interpretation setValue 0
"Normalize Grayscale 2" outputLocation setIndex 0 0
"Normalize Grayscale 2" inputImage connect "$imageStackName"
"Normalize Grayscale 2" fire
"Normalize Grayscale 2" rangeMode setIndex 0 1
"Normalize Grayscale 2" fire
"Normalize Grayscale 2" inputRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale 2" inputRange setValue 0 0
"Normalize Grayscale 2" inputRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale 2" inputRange setValue 1 20000
"Normalize Grayscale 2" fire
"Normalize Grayscale 2" percentage setMinMax 0 0 3.40282346638529e+038
"Normalize Grayscale 2" percentage setValue 0 2
"Normalize Grayscale 2" percentage setMinMax 1 0 3.40282346638529e+038
"Normalize Grayscale 2" percentage setValue 1 98
"Normalize Grayscale 2" fire
"Normalize Grayscale 2" outputRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale 2" outputRange setValue 0 0
"Normalize Grayscale 2" outputRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale 2" outputRange setValue 1 65534
"Normalize Grayscale 2" fire
"Normalize Grayscale 2" applyTransformToResult 1
"Normalize Grayscale 2" fire
"Normalize Grayscale 2" setViewerMask 16383
"Normalize Grayscale 2" setPickable 1

set hideNewModules 0
[ {Normalize Grayscale 2} create ImgOut ] setLabel "$imageStackName.corrected"
"$imageStackName.corrected" setIconPosition 12 226
"$imageStackName.corrected" master connect "Normalize Grayscale 2" "ImgOut" 0
"$imageStackName.corrected" sharedColormap disconnect
"$imageStackName.corrected" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.corrected" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.corrected" sharedColormap activateLocalRange 1
"$imageStackName.corrected" sharedColormap setLocalMinMax 0.000000 1.000000
"$imageStackName.corrected" sharedColormap enableAlpha 1
"$imageStackName.corrected" sharedColormap enableAlphaToggle 1
"$imageStackName.corrected" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.corrected" sharedColormap setColorbarMinMax 0 255
"$imageStackName.corrected" fire
"$imageStackName.corrected" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.corrected" fire
"$imageStackName.corrected" setViewerMask 16383

set hideNewModules 0
create fastmaxima "Regional Maxima"
"Regional Maxima" setIconPosition 59 267
"Regional Maxima" setVar "CustomHelp" {fastmaxima.html}
"Regional Maxima" interpretation setValue 0
"Regional Maxima" outputLocation setIndex 0 0
"Regional Maxima" neighborhood setValue 2
"Regional Maxima" inputImage connect "$imageStackName.corrected"
"Regional Maxima" applyTransformToResult 1
"Regional Maxima" fire
"Regional Maxima" setViewerMask 16383
"Regional Maxima" setPickable 1
"Regional Maxima" doIt snap 0 1

set hideNewModules 0
[ {Regional Maxima} create ImgOutBin ] setLabel "$imageStackName.maxima"
"$imageStackName.maxima" setIconPosition 12 302
"$imageStackName.maxima" master connect "Regional Maxima" "ImgOutBin" 0
"$imageStackName.maxima" sharedColormap connect "labels.am"
"$imageStackName.maxima" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.maxima" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.maxima" sharedColormap activateLocalRange 1
"$imageStackName.maxima" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.maxima" sharedColormap enableAlpha 1
"$imageStackName.maxima" sharedColormap enableAlphaToggle 1
"$imageStackName.maxima" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.maxima" sharedColormap setColorbarMinMax 1 8
"$imageStackName.maxima" fire
"$imageStackName.maxima" primary setIndex 0 0
"$imageStackName.maxima" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.maxima" fire
"$imageStackName.maxima" setViewerMask 16383

set hideNewModules 0
create removalsmallspots "Remove Small Spots"
"Remove Small Spots" setIconPosition 50 333
"Remove Small Spots" setVar "CustomHelp" {removalsmallspots.html}
"Remove Small Spots" interpretation setValue 1
"Remove Small Spots" outputLocation setIndex 0 0
"Remove Small Spots" inputImage connect "$imageStackName.maxima"
"Remove Small Spots" size setMinMax 0 0 3.40282346638529e+038
"Remove Small Spots" size setValue 0 20
"Remove Small Spots" applyTransformToResult 1
"Remove Small Spots" fire
"Remove Small Spots" setViewerMask 16383
"Remove Small Spots" setPickable 1

set hideNewModules 0
[ {Remove Small Spots} create ImgOut ] setLabel "$imageStackName.filtered"
"$imageStackName.filtered" setIconPosition 14 376
"$imageStackName.filtered" master connect "Remove Small Spots" "ImgOut" 0
"$imageStackName.filtered" sharedColormap connect "labels.am"
"$imageStackName.filtered" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.filtered" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.filtered" sharedColormap activateLocalRange 1
"$imageStackName.filtered" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.filtered" sharedColormap enableAlpha 1
"$imageStackName.filtered" sharedColormap enableAlphaToggle 1
"$imageStackName.filtered" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.filtered" sharedColormap setColorbarMinMax 1 8
"$imageStackName.filtered" fire
"$imageStackName.filtered" primary setIndex 0 0
"$imageStackName.filtered" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.filtered" fire
"$imageStackName.filtered" setViewerMask 16383

set hideNewModules 0
create removalsmallspots "Remove Small Spots 2"
"Remove Small Spots 2" setIconPosition 41 417
"Remove Small Spots 2" setVar "CustomHelp" {removalsmallspots.html}
"Remove Small Spots 2" interpretation setValue 0
"Remove Small Spots 2" outputLocation setIndex 0 0
"Remove Small Spots 2" inputImage connect "$imageStackName.filtered"
"Remove Small Spots 2" size setMinMax 0 0 3.40282346638529e+038
"Remove Small Spots 2" size setValue 0 500
"Remove Small Spots 2" applyTransformToResult 1
"Remove Small Spots 2" fire
"Remove Small Spots 2" setViewerMask 16383
"Remove Small Spots 2" setPickable 1

set hideNewModules 0
[ {Remove Small Spots 2} create ImgOut ] setLabel "$imageStackName.filtered2"
"$imageStackName.filtered2" setIconPosition 13 453
"$imageStackName.filtered2" master connect "Remove Small Spots 2" "ImgOut" 0
"$imageStackName.filtered2" sharedColormap connect "labels.am"
"$imageStackName.filtered2" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.filtered2" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.filtered2" sharedColormap activateLocalRange 1
"$imageStackName.filtered2" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.filtered2" sharedColormap enableAlpha 1
"$imageStackName.filtered2" sharedColormap enableAlphaToggle 1
"$imageStackName.filtered2" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.filtered2" sharedColormap setColorbarMinMax 1 8
"$imageStackName.filtered2" fire
"$imageStackName.filtered2" primary setIndex 0 0
"$imageStackName.filtered2" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.filtered2" fire
"$imageStackName.filtered2" setViewerMask 16383

set hideNewModules 0
create HxAnalyzeLabels "Label Analysis"
"Label Analysis" setIconPosition 470 243
"Label Analysis" setVar "CustomHelp" {HxAnalyzeLabels}
"Label Analysis" data connect "$imageStackName.filtered2"
"Label Analysis" fire
"Label Analysis" interpretation setValue 0
"Label Analysis" sequenceMode setValue 0
labelMeasure scheduleRestore "{42bb78e0-72ae-4605-bd01-13218b856edb}" "finalDist" 5 "( BaryCenterX - cx*gx/2)**2 + ( BaryCenterY - cy*gy/2)**2 + (BaryCenterZ - cz*gz/2)**2"
labelMeasure scheduleRestore "{c449ffd7-8108-416b-8c15-86a06391a9b6}" "SVratio" 5 "Area3d/ Volume3d  "
labelMeasure processScheduledRestore
labelMeasure setAttributes feret2d 0 18 36 54 72 90 108 126 144 162
labelMeasure setAttributes feret3d 31
labelMeasure setAttributes cooccurrence 0 0
labelMeasure setAttributes histogram 1 0 255 1
labelMeasure setAttributes quantile 0.1 0.1 0.1 0.1 0.1 0.1
labelMeasure setAttributes breadth3d 10
"Label Analysis" measures setState {"segGroup" {42bb78e0-72ae-4605-bd01-13218b856edb} Volume3d Breadth3d Area3d Shape_VA3d Thickness3d Anisotropy Perimeter FeretShape3d Length3d Width3d BreadthOrientPhi BreadthOrientTheta LengthOrientPhi LengthOrientTheta WidthOrientPhi WidthOrientTheta Area AreaFraction BorderVoxelCount CroftonPerimeter EqDiameter Euler3D IntegralMeanCurvature IntegralTotalCurvature Orientation2Phi Orientation2Theta OrientationPhi OrientationTheta Volume Volume2 VoxelFaceArea Elongation Flatness BoundingBoxDx BoundingBoxDy BoundingBoxDz BinMom2x BinMom2y BinMom2z BinMomxy BinMomxz BinMomyz EigenVal1 EigenVal2 EigenVal3 EigenVec1X EigenVec1Y EigenVec1Z EigenVec2X EigenVec2Y EigenVec2Z EigenVec3X EigenVec3Y EigenVec3Z ExtentMax1 ExtentMax2 ExtentMax3 ExtentMin1 ExtentMin2 ExtentMin3 {c449ffd7-8108-416b-8c15-86a06391a9b6}}
"Label Analysis" showAnalysis setValue 0 1
"Label Analysis" showAnalysis setToggleVisible 0 1
"Label Analysis" applyTransformToResult 1
"Label Analysis" fire
"Label Analysis" setViewerMask 16383
"Label Analysis" setPickable 1

set hideNewModules 0
[ {Label Analysis} create AnlOut ] setLabel "$imageStackName.Label-Analysis"
"$imageStackName.Label-Analysis" setIconPosition 280 228
"$imageStackName.Label-Analysis" master connect "Label Analysis" "AnlOut" 0
"$imageStackName.Label-Analysis" fire
"$imageStackName.Label-Analysis" fire
"$imageStackName.Label-Analysis" setViewerMask 16383

set hideNewModules 0
[ {Label Analysis} create ImgOutLab ] setLabel "$imageStackName.label"
"$imageStackName.label" setIconPosition 268 189
"$imageStackName.label" master connect "Label Analysis" "ImgOutLab" 1
"$imageStackName.label" sharedColormap connect "labels.am"
"$imageStackName.label" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.label" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.label" sharedColormap activateLocalRange 1
"$imageStackName.label" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.label" sharedColormap enableAlpha 1
"$imageStackName.label" sharedColormap enableAlphaToggle 1
"$imageStackName.label" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.label" sharedColormap setColorbarMinMax 1 8
"$imageStackName.label" fire
"$imageStackName.label" primary setIndex 0 0
"$imageStackName.label" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.label" fire
"$imageStackName.label" setViewerMask 16383
}

if {["$imageStackName.Label-Analysis" getNumRows] > 1} { 
set hideNewModules 0
create HxFilterAnalysis "Analysis Filter"
"Analysis Filter" setIconPosition 408 261
"Analysis Filter" setVar "CustomHelp" {HxFilterAnalysis}
"Analysis Filter" data connect "$imageStackName.Label-Analysis"
"Analysis Filter" image connect "$imageStackName.label"
"Analysis Filter" fire
"Analysis Filter" filter setState { Volume3d < 7}
"Analysis Filter" showAnalysis setValue 0 1
"Analysis Filter" showAnalysis setToggleVisible 0 1
"Analysis Filter" applyTransformToResult 1
"Analysis Filter" fire
"Analysis Filter" setViewerMask 16383
"Analysis Filter" setPickable 1

set hideNewModules 0
[ {Analysis Filter} create AnlOut ] setLabel "$imageStackName.Analysis-Filter"
"$imageStackName.Analysis-Filter" setIconPosition 268 300
"$imageStackName.Analysis-Filter" master connect "Analysis Filter" "AnlOut" 0
"$imageStackName.Analysis-Filter" fire
"$imageStackName.Analysis-Filter" fire
"$imageStackName.Analysis-Filter" setViewerMask 16383

set hideNewModules 0
[ {Analysis Filter} create result1 ] setLabel "$imageStackName.label-filtering"
"$imageStackName.label-filtering" setIconPosition 266 335
"$imageStackName.label-filtering" master connect "Analysis Filter" "result1" 1
"$imageStackName.label-filtering" sharedColormap connect "labels.am"
"$imageStackName.label-filtering" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.label-filtering" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.label-filtering" sharedColormap activateLocalRange 1
"$imageStackName.label-filtering" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.label-filtering" sharedColormap enableAlpha 1
"$imageStackName.label-filtering" sharedColormap enableAlphaToggle 1
"$imageStackName.label-filtering" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.label-filtering" sharedColormap setColorbarMinMax 1 8
"$imageStackName.label-filtering" fire
"$imageStackName.label-filtering" primary setIndex 0 0
"$imageStackName.label-filtering" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.label-filtering" fire
"$imageStackName.label-filtering" setViewerMask 16383

set hideNewModules 0
create HxInteractiveThreshold "Interactive Thresholding"
"Interactive Thresholding" setViewerMask 0
"Interactive Thresholding" setIconPosition 304 327
"Interactive Thresholding" setVar "CustomHelp" {HxInteractiveThreshold}
set hideNewModules 0

"Interactive Thresholding" data connect "$imageStackName.label-filtering"
"Interactive Thresholding" inputColorMap connect "labels.am"
"Interactive Thresholding" inputColorMap setDefaultColor 1 0.8 0.5
"Interactive Thresholding" inputColorMap setDefaultAlpha 0.500000
"Interactive Thresholding" inputColorMap activateLocalRange 1
"Interactive Thresholding" inputColorMap setLocalMinMax 1.000000 8.000000
"Interactive Thresholding" inputColorMap enableAlpha 1
"Interactive Thresholding" inputColorMap enableAlphaToggle 1
"Interactive Thresholding" inputColorMap setAutoAdjustRangeMode 1
"Interactive Thresholding" inputColorMap setColorbarMinMax 0.65 8.35
"Interactive Thresholding" fire
"Interactive Thresholding" preview setValue 0 1
"Interactive Thresholding" preview setToggleVisible 0 1
"Interactive Thresholding" preview setValue 1 0
"Interactive Thresholding" preview setToggleVisible 1 1
"Interactive Thresholding" orientation setValue 0
"Interactive Thresholding" sliceNumber setMinMax 0 200
"Interactive Thresholding" sliceNumber setButtons 1
"Interactive Thresholding" sliceNumber setEditButton 1
"Interactive Thresholding" sliceNumber setIncrement 1
"Interactive Thresholding" sliceNumber setValue 0
"Interactive Thresholding" sliceNumber setSubMinMax 0 200
"Interactive Thresholding" rendering setValue 1
"Interactive Thresholding" intensityRange setMinMax 0 65535
"Interactive Thresholding" intensityRange setValues 1 29
"Interactive Thresholding" intensityRange setButtons 0
"Interactive Thresholding" intensityRange setEditButton 1
"Interactive Thresholding" intensityRange setIncrement 4369
"Interactive Thresholding" intensityRange setSubMinMax 0 0
"Interactive Thresholding" colorMask setColor 0 0 0 1
"Interactive Thresholding" applyTransformToResult 1
"Interactive Thresholding" fire
"Interactive Thresholding" setViewerMask 16383
"Interactive Thresholding" setPickable 1

set hideNewModules 0
[ {Interactive Thresholding} create result ] setLabel "$imageStackName.segmented"
"$imageStackName.segmented" setIconPosition 288 365
"$imageStackName.segmented" master connect "Interactive Thresholding" "result" 0
"$imageStackName.segmented" sharedColormap connect "labels.am"
"$imageStackName.segmented" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.segmented" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.segmented" sharedColormap activateLocalRange 1
"$imageStackName.segmented" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.segmented" sharedColormap enableAlpha 1
"$imageStackName.segmented" sharedColormap enableAlphaToggle 1
"$imageStackName.segmented" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.segmented" sharedColormap setColorbarMinMax 1 8
"$imageStackName.segmented" fire
"$imageStackName.segmented" primary setIndex 0 0
"$imageStackName.segmented" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.segmented" fire
"$imageStackName.segmented" setViewerMask 16383

} else {
"$imageStackName.Label-Analysis" setLabel "$imageStackName.Analysis-Filter"
"$imageStackName.label" setLabel "$imageStackName.segmented"
}

set imageStackBoundary [getBoundary "$imageStackName.segmented"]


if {[isDirectoryOrFileExist [file join [file dirname [file dirname $imageStackPath]] segmented $imageStackName\SEG$extension]]} {
	getTBSegmentation $imageStackName $imageStackBoundary [file dirname [file dirname $imageStackPath]] $extension $voxelSizeX $voxelSizeY $voxelSizeZ
}

saveFiles $imageStackName $imageStackBoundary "$imageStackName.segmented" "$imageStackName.Analysis-Filter" $cellFolderOutputPath $extension $fileFormat 

"$imageStackName" setNoRemove 1
"$imageStackName" setNoRemoveAll 1
"$imageStackBoundary" setNoRemove 1
"$imageStackBoundary" setNoRemoveAll 1
"$imageStackName.segmented" setNoRemove 1
"$imageStackName.segmented" setNoRemoveAll 1

remove -all

verificationProject $imageStackName $imageStackBoundary "$imageStackName.segmented" $cellFolderOutputPath

"$imageStackName" setNoRemove 0
"$imageStackName" setNoRemoveAll 0
"$imageStackBoundary" setNoRemove 0
"$imageStackBoundary" setNoRemoveAll 0
"$imageStackName.segmented" setNoRemove 0
"$imageStackName.segmented" setNoRemoveAll 0

remove -all
}

#Function called to process the nucleus (report p 41)
proc nucleus {imageStackPath cellFolderOutputPath fileFormat structuringElementSize shapeAnalysisCSVFile voxelSizeX voxelSizeY voxelSizeZ} {

#Extract only the stack name from the image stack path.
set imageStackName [file tail [file rootname $imageStackPath]]
#Extract the extension of the image stack (supposed to be ".tif" or ".TIF").
set extension [file extension $imageStackPath]

#Try to load the nucleus stack, if a problem occurs, stop the processing of the stack and remove all the modules in the project view in anticipation of the next call of a processing function (membrane, nucleus, scaffold or paxilin).
if {[catch {[load -tif +mode 100 +box 0 104.312 0 104.104 0 50 $imageStackPath] setLabel "$imageStackName"}]} {
	remove -all
	return
}
#Set the correct voxel size of the stack
resample $imageStackName $voxelSizeX $voxelSizeY $voxelSizeZ

if 1 {
#Pre-processing (report p 29)
set hideNewModules 0
create normalize "Normalize Grayscale"
"Normalize Grayscale" setIconPosition 63 199
"Normalize Grayscale" setVar "CustomHelp" {normalize.html}
"Normalize Grayscale" interpretation setValue 0
"Normalize Grayscale" outputLocation setIndex 0 0
#Choose the label to connect to the grayscale normalization module
"Normalize Grayscale" inputImage connect "$imageStackName"
"Normalize Grayscale" fire
"Normalize Grayscale" rangeMode setIndex 0 1
"Normalize Grayscale" fire
"Normalize Grayscale" inputRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
#Set the lower threshold a
"Normalize Grayscale" inputRange setValue 0 7000
"Normalize Grayscale" inputRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
#Set the upper threshold b
"Normalize Grayscale" inputRange setValue 1 7000
"Normalize Grayscale" fire
"Normalize Grayscale" percentage setMinMax 0 0 3.40282346638529e+038
"Normalize Grayscale" percentage setValue 0 2
"Normalize Grayscale" percentage setMinMax 1 0 3.40282346638529e+038
"Normalize Grayscale" percentage setValue 1 98
"Normalize Grayscale" fire
"Normalize Grayscale" outputRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
#Set the ouput value c
"Normalize Grayscale" outputRange setValue 0 0
"Normalize Grayscale" outputRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
#Set the output value d
"Normalize Grayscale" outputRange setValue 1 65072
#Apply the module to the label
"Normalize Grayscale" fire
"Normalize Grayscale" applyTransformToResult 1
"Normalize Grayscale" fire
"Normalize Grayscale" setViewerMask 16383
"Normalize Grayscale" setPickable 1

#Create result of the grayscale normalization
set hideNewModules 0
[ {Normalize Grayscale} create ImgOut ] setLabel "$imageStackName.corrected"
"$imageStackName.corrected" setIconPosition 63 238
"$imageStackName.corrected" master connect "Normalize Grayscale" "ImgOut" 0
"$imageStackName.corrected" sharedColormap disconnect
"$imageStackName.corrected" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.corrected" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.corrected" sharedColormap activateLocalRange 1
"$imageStackName.corrected" sharedColormap setLocalMinMax 0.000000 1.000000
"$imageStackName.corrected" sharedColormap enableAlpha 1
"$imageStackName.corrected" sharedColormap enableAlphaToggle 1
"$imageStackName.corrected" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.corrected" sharedColormap setColorbarMinMax 0 65072
"$imageStackName.corrected" fire
"$imageStackName.corrected" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.corrected" fire
"$imageStackName.corrected" setViewerMask 16383

#Otsu thresholding (report p 30)
set hideNewModules 0
create auto_threshold "Auto Thresholding"
"Auto Thresholding" setIconPosition 13 438
"Auto Thresholding" setVar "CustomHelp" {auto_threshold}
"Auto Thresholding" Type setState {type Auto Threshold High}
"Auto Thresholding" interpretation setValue 0
"Auto Thresholding" outputLocation setIndex 0 0
#Choose the label to connect to the otsu thresholding module
"Auto Thresholding" inputImage connect "$imageStackName.corrected"
"Auto Thresholding" fire
"Auto Thresholding" mode setIndex 0 0
"Auto Thresholding" fire
"Auto Thresholding" inputRange setMinMax 0 -2147483648 2147483648
"Auto Thresholding" inputRange setValue 0 0
"Auto Thresholding" inputRange setMinMax 1 -2147483648 2147483648
"Auto Thresholding" inputRange setValue 1 65535
"Auto Thresholding" fire
"Auto Thresholding" criterion setIndex 0 1
"Auto Thresholding" fire
"Auto Thresholding" applyTransformToResult 1
"Auto Thresholding" fire
"Auto Thresholding" setViewerMask 16383
"Auto Thresholding" setPickable 1

#Create results of otsu thresholding
set hideNewModules 0
[ {Auto Thresholding} create ImgOutBin ] setLabel "$imageStackName.labels"
"$imageStackName.labels" setIconPosition 14 468
"$imageStackName.labels" master connect "Auto Thresholding" "ImgOutBin" 0
"$imageStackName.labels" sharedColormap connect "labels.am"
"$imageStackName.labels" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.labels" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.labels" sharedColormap activateLocalRange 1
"$imageStackName.labels" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.labels" sharedColormap enableAlpha 1
"$imageStackName.labels" sharedColormap enableAlphaToggle 1
"$imageStackName.labels" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.labels" sharedColormap setColorbarMinMax 1 8
"$imageStackName.labels" fire
"$imageStackName.labels" primary setIndex 0 0
"$imageStackName.labels" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.labels" fire
"$imageStackName.labels" setViewerMask 16383

set hideNewModules 0
[ {Auto Thresholding} create MOutMsrSheet ] setLabel "$imageStackName.info"
"$imageStackName.info" setIconPosition 14 499
"$imageStackName.info" master connect "Auto Thresholding" "MOutMsrSheet" 1
"$imageStackName.info" fire
"$imageStackName.info" fire
"$imageStackName.info" setViewerMask 16383
"$imageStackName.info" select
}


#Post-processing, label of the post processed stack is stored in the variable.
set imageStackPostProcessed [postProcessing "$imageStackName.labels" "closing" $structuringElementSize]

#Extract parameters from the processed label.
set labelAnalysisResults [labelAnalysis $imageStackPostProcessed [file tail $cellFolderOutputPath]]
#Get the list of parameters extracted from the Avizo table
set parametersForShapeAnalysis [lindex $labelAnalysisResults 0]
#Get the label of the processed stack
set imageStackProcessed [lindex $labelAnalysisResults 1]
#Get the label of the Avizo table
set imageStackAnalysisFilter [lindex $labelAnalysisResults 2]

#Create a boundary stack, get its label in the variable
set imageStackBoundary [getBoundary $imageStackProcessed]

#Call a function loading in the project the stack processed by ImageJ if it exists
if {[isDirectoryOrFileExist [file join [file dirname [file dirname $imageStackPath]] segmented $imageStackName\SEG$extension]]} {
	getTBSegmentation $imageStackName $imageStackBoundary [file dirname [file dirname $imageStackPath]] $extension $voxelSizeX $voxelSizeY $voxelSizeZ
}

#Save the stacks, tables, project files in the output structure
saveFiles $imageStackName $imageStackBoundary $imageStackProcessed $imageStackAnalysisFilter $cellFolderOutputPath $extension $fileFormat 

#Prevent the following labels from being removed from the project view
"$imageStackName" setNoRemove 1
"$imageStackName" setNoRemoveAll 1
"$imageStackProcessed" setNoRemove 1
"$imageStackProcessed" setNoRemoveAll 1
"$imageStackBoundary" setNoRemove 1
"$imageStackBoundary" setNoRemoveAll 1

#Clean the project view
remove -all

#Save the remaining labels in a project file in the verification folder
verificationProject $imageStackName $imageStackBoundary $imageStackProcessed $cellFolderOutputPath

#Autorize again the removal of the following labels
"$imageStackName" setNoRemove 0
"$imageStackName" setNoRemoveAll 0
"$imageStackBoundary" setNoRemove 0
"$imageStackBoundary" setNoRemoveAll 0

remove -all

#If the user selected ellipsoid fit
if {$flags::isEllipsoidFit} {
	#Get the list of parameters resulting from the ellipsoid fit
	set radiusList [ellipsoidFit $imageStackProcessed $cellFolderOutputPath $voxelSizeX $voxelSizeY $voxelSizeZ]
	#if the list doesn't contain "problem with matlab"
	if {$radiusList != "problem with matlab"} {
		#Get the parameters from radiusList
		#Radiuses of the ellipsoid
		set a [lindex $radiusList 0]
		set b [lindex $radiusList 1]
		set c [lindex $radiusList 2]
		#Coordinates of the center of the ellipsoid
		set xc [lindex $radiusList 3]
		set yc [lindex $radiusList 4]
		set zc [lindex $radiusList 5]
		#Angles of the ellipsoid
		set alpha [lindex $radiusList 6]
		set beta [lindex $radiusList 7]
		set gamma [lindex $radiusList 8]
		#Sphericity of the ellipsoid
		set ellipsoidSphericity [lindex $radiusList 9]
		#Volume of the ellipsoid
		set ellipsoidVolume [lindex $radiusList 10]
		echo $ellipsoidVolume
		#Get the volume of the processed stack from the list parametersForShapeAnalysis
		set stackVolume [lindex $parametersForShapeAnalysis 1]
		echo $stackVolume
		#Calculate the relation between the processed stack volume and the ellipsoid volume
		set extraVolume [expr (($stackVolume/$ellipsoidVolume)-1)*100]
		#Append the ellipsoid parameters in the list parametersForShapeAnalysis
		lappend parametersForShapeAnalysis $a $b $c $xc $yc $zc $alpha $beta $gamma $ellipsoidSphericity $ellipsoidVolume $extraVolume
		#Append the list of parameters in the global CSV file for membrane stacks
		writeCSVFile $shapeAnalysisCSVFile $parametersForShapeAnalysis "," "append"
	#if the list contains "problem with matlab"
	} else {
		#Append the list of parameters in the global CSV file for membrane stacks without ellipsoid parameters
		writeCSVFile $shapeAnalysisCSVFile $parametersForShapeAnalysis "," "append"
	}
#If the user didn't select ellipsoid fit
} else {
#Append the list of parameters in the global CSV file for membrane stacks without ellipsoid parameters
	writeCSVFile $shapeAnalysisCSVFile $parametersForShapeAnalysis "," "append"
}

#Prevent the label of the processed stack from being removed if the user wants to use the combine the processed nucleus stack and the segmented membrane stack in the membrane function.
if {!$flags::isUseNucleusForMembrane && $flags::isMembrane} {
	"$imageStackProcessed" setNoRemove 0
	"$imageStackProcessed" setNoRemoveAll 0
}

remove -all
}

#Function called to process the scaffold (report p 42)
#This function is not commented and need to be modified
proc scaffold {imageStackPath cellFolderOutputPath fileFormat referenceImage membraneThreshold shapeAnalysisCSVFile voxelSizeX voxelSizeY voxelSizeZ} {
set imageStackName [file tail [file rootname $imageStackPath]]
set extension [file extension $imageStackPath]

if {[catch {[load -tif +mode 100 +box 0 1 0 1 0 1 $referenceImage] setLabel "referenceImage"}]} {
	remove -all
	return
}
resample referenceImage $voxelSizeX $voxelSizeY $voxelSizeZ

if {[catch {[load -tif +mode 100 +box 0 104.312 0 104.104 0 50 $imageStackPath] setLabel "$imageStackName"}]} {
	remove -all
	return
}
resample $imageStackName $voxelSizeX $voxelSizeY $voxelSizeZ

if 1 {
set hideNewModules 0
create medianfilter "Median Filter"
"Median Filter" setIconPosition 52 128
"Median Filter" setVar "CustomHelp" {medianfilter3d.html}
"Median Filter" interpretation setValue 0
"Median Filter" outputLocation setIndex 0 0
"Median Filter" neighborhood setValue 2
"Median Filter" inputImage connect "$imageStackName"
"Median Filter" type setIndex 0 0
"Median Filter" iterations setMinMax 0 0 2147483648
"Median Filter" iterations setValue 0 3
"Median Filter" applyTransformToResult 1
"Median Filter" fire
"Median Filter" setViewerMask 16383
"Median Filter" setPickable 1

set hideNewModules 0
[ {Median Filter} create ImgOut ] setLabel "$imageStackName.filtered"
"$imageStackName.filtered" setIconPosition 20 161
"$imageStackName.filtered" master connect "Median Filter" "ImgOut" 0
"$imageStackName.filtered" sharedColormap disconnect
"$imageStackName.filtered" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.filtered" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.filtered" sharedColormap activateLocalRange 1
"$imageStackName.filtered" sharedColormap setLocalMinMax 0.000000 1.000000
"$imageStackName.filtered" sharedColormap enableAlpha 1
"$imageStackName.filtered" sharedColormap enableAlphaToggle 1
"$imageStackName.filtered" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.filtered" sharedColormap setColorbarMinMax 0 55942
"$imageStackName.filtered" fire
"$imageStackName.filtered" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.filtered" fire
"$imageStackName.filtered" setViewerMask 16383
}

set imageStackContrastMatching [contrastMatching "$imageStackName.filtered" referenceImage]

if 1 {
set hideNewModules 0
create logical_not "NOT"
"NOT" setIconPosition 13 381
"NOT" setVar "CustomHelp" {logical_not.html}
"NOT" interpretation setValue 0
"NOT" outputLocation setIndex 0 0
"NOT" inputImage connect "$imageStackContrastMatching"
"NOT" applyTransformToResult 1
"NOT" fire
"NOT" setViewerMask 16383
"NOT" setPickable 1

set hideNewModules 0
[ {NOT} create ImgOut ] setLabel "$imageStackName.not"
"$imageStackName.not" setIconPosition 14 408
"$imageStackName.not" master connect "NOT" "ImgOut" 0
"$imageStackName.not" sharedColormap disconnect
"$imageStackName.not" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.not" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.not" sharedColormap activateLocalRange 1
"$imageStackName.not" sharedColormap setLocalMinMax 0.000000 1.000000
"$imageStackName.not" sharedColormap enableAlpha 1
"$imageStackName.not" sharedColormap enableAlphaToggle 1
"$imageStackName.not" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.not" sharedColormap setColorbarMinMax 0 65535
"$imageStackName.not" fire
"$imageStackName.not" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.not" fire
"$imageStackName.not" setViewerMask 16383

set hideNewModules 0
create normalize "Normalize Grayscale"
"Normalize Grayscale" setIconPosition 593 219
"Normalize Grayscale" setVar "CustomHelp" {normalize.html}
"Normalize Grayscale" interpretation setValue 0
"Normalize Grayscale" outputLocation setIndex 0 0
"Normalize Grayscale" inputImage connect "$imageStackName.not"
"Normalize Grayscale" fire
"Normalize Grayscale" rangeMode setIndex 0 0
"Normalize Grayscale" fire
"Normalize Grayscale" inputRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale" inputRange setValue 0 0
"Normalize Grayscale" inputRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale" inputRange setValue 1 255
"Normalize Grayscale" fire
"Normalize Grayscale" percentage setMinMax 0 0 3.40282346638529e+038
"Normalize Grayscale" percentage setValue 0 2
"Normalize Grayscale" percentage setMinMax 1 0 3.40282346638529e+038
"Normalize Grayscale" percentage setValue 1 98
"Normalize Grayscale" fire
"Normalize Grayscale" outputRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale" outputRange setValue 0 0
"Normalize Grayscale" outputRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Normalize Grayscale" outputRange setValue 1 255
"Normalize Grayscale" fire
"Normalize Grayscale" applyTransformToResult 1
"Normalize Grayscale" fire
"Normalize Grayscale" setViewerMask 16383
"Normalize Grayscale" setPickable 1
"Normalize Grayscale" doIt snap 0 1

set hideNewModules 0
[ {Normalize Grayscale} create ImgOut ] setLabel "$imageStackName.corrected"
"$imageStackName.corrected" setIconPosition 519 260
"$imageStackName.corrected" master connect "Normalize Grayscale" "ImgOut" 0
"$imageStackName.corrected" sharedColormap disconnect
"$imageStackName.corrected" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.corrected" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.corrected" sharedColormap activateLocalRange 1
"$imageStackName.corrected" sharedColormap setLocalMinMax 0.000000 1.000000
"$imageStackName.corrected" sharedColormap enableAlpha 1
"$imageStackName.corrected" sharedColormap enableAlphaToggle 1
"$imageStackName.corrected" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.corrected" sharedColormap setColorbarMinMax 0 255
"$imageStackName.corrected" fire
"$imageStackName.corrected" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.corrected" fire
"$imageStackName.corrected" setViewerMask 16383

set hideNewModules 0
create hysteresis "Hysteresis Thresholding"
"Hysteresis Thresholding" setIconPosition 279 183
"Hysteresis Thresholding" setVar "CustomHelp" {hysteresis.html}
"Hysteresis Thresholding" interpretation setValue 0
"Hysteresis Thresholding" outputLocation setIndex 0 0
"Hysteresis Thresholding" inputImage connect "$imageStackName.corrected"
"Hysteresis Thresholding" thresholds setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Hysteresis Thresholding" thresholds setValue 0 200
"Hysteresis Thresholding" thresholds setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Hysteresis Thresholding" thresholds setValue 1 255
"Hysteresis Thresholding" length setMinMax 0 0 2147483648
"Hysteresis Thresholding" length setValue 0 0
"Hysteresis Thresholding" applyTransformToResult 1
"Hysteresis Thresholding" fire
"Hysteresis Thresholding" setViewerMask 16383
"Hysteresis Thresholding" setPickable 1
"Hysteresis Thresholding" doIt snap 0 1

set hideNewModules 0
[ {Hysteresis Thresholding} create ImgOutBin ] setLabel "$imageStackName.binary"
"$imageStackName.binary" setIconPosition 36 188
"$imageStackName.binary" master connect "Hysteresis Thresholding" "ImgOutBin" 0
"$imageStackName.binary" sharedColormap connect "labels.am"
"$imageStackName.binary" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.binary" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.binary" sharedColormap activateLocalRange 1
"$imageStackName.binary" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.binary" sharedColormap enableAlpha 1
"$imageStackName.binary" sharedColormap enableAlphaToggle 1
"$imageStackName.binary" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.binary" sharedColormap setColorbarMinMax 1 8
"$imageStackName.binary" fire
"$imageStackName.binary" primary setIndex 0 0
"$imageStackName.binary" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.binary" fire
"$imageStackName.binary" setViewerMask 16383

set hideNewModules 0
create binseparate "Separate Objects"
"Separate Objects" setIconPosition 273 11
"Separate Objects" setVar "CustomHelp" {binseparate}
"Separate Objects" Method setState {type Chamfer - Conservative}
"Separate Objects" interpretation setValue 0
"Separate Objects" outputLocation setIndex 0 0
"Separate Objects" neighborhood setValue 2
"Separate Objects" inputBinaryImage connect "$imageStackName.binary"
"Separate Objects" markerExtent setMinMax 0 0 2147483648
"Separate Objects" markerExtent setValue 0 4
"Separate Objects" outputType setIndex 0 0
"Separate Objects" algorithmMode setIndex 0 0
"Separate Objects" applyTransformToResult 1
"Separate Objects" fire
"Separate Objects" setViewerMask 16383
"Separate Objects" setPickable 1

set hideNewModules 0
[ {Separate Objects} create ImgOutBinOrLab ] setLabel "$imageStackName.separate"
"$imageStackName.separate" setIconPosition 275 40
"$imageStackName.separate" master connect "Separate Objects" "ImgOutBinOrLab" 0
"$imageStackName.separate" sharedColormap connect "labels.am"
"$imageStackName.separate" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.separate" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.separate" sharedColormap activateLocalRange 1
"$imageStackName.separate" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.separate" sharedColormap enableAlpha 1
"$imageStackName.separate" sharedColormap enableAlphaToggle 1
"$imageStackName.separate" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.separate" sharedColormap setColorbarMinMax 1 8
"$imageStackName.separate" fire
"$imageStackName.separate" primary setIndex 0 0
"$imageStackName.separate" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.separate" fire
"$imageStackName.separate" setViewerMask 16383

set hideNewModules 0
create hole_fill2d "Fill Holes"
"Fill Holes" setIconPosition 333 560
"Fill Holes" setVar "CustomHelp" {hole_fill2d.html}
"Fill Holes" interpretation setValue 1
"Fill Holes" outputLocation setIndex 0 0
"Fill Holes" inputImage connect "$imageStackName.separate"
"Fill Holes" neighborhoodConnectivity setIndex 0 0
"Fill Holes" applyTransformToResult 1
"Fill Holes" fire
"Fill Holes" setViewerMask 16383
"Fill Holes" setPickable 1

set hideNewModules 0
[ {Fill Holes} create ImgOut ] setLabel "$imageStackName.filled"
"$imageStackName.filled" setIconPosition 333 590
"$imageStackName.filled" master connect "Fill Holes" "ImgOut" 0
"$imageStackName.filled" sharedColormap connect "labels.am"
"$imageStackName.filled" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.filled" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.filled" sharedColormap activateLocalRange 1
"$imageStackName.filled" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.filled" sharedColormap enableAlpha 1
"$imageStackName.filled" sharedColormap enableAlphaToggle 1
"$imageStackName.filled" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.filled" sharedColormap setColorbarMinMax 1 8
"$imageStackName.filled" fire
"$imageStackName.filled" primary setIndex 0 0
"$imageStackName.filled" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.filled" fire
"$imageStackName.filled" setViewerMask 16383

set hideNewModules 0
create removalsmallspots "Remove Small Spots"
"Remove Small Spots" setIconPosition 273 67
"Remove Small Spots" setVar "CustomHelp" {removalsmallspots.html}
"Remove Small Spots" interpretation setValue 0
"Remove Small Spots" outputLocation setIndex 0 0
"Remove Small Spots" inputImage connect "$imageStackName.filled"
"Remove Small Spots" size setMinMax 0 0 3.40282346638529e+038
"Remove Small Spots" size setValue 0 1000000
"Remove Small Spots" applyTransformToResult 1
"Remove Small Spots" fire
"Remove Small Spots" setViewerMask 16383
"Remove Small Spots" setPickable 1

set hideNewModules 0
[ {Remove Small Spots} create ImgOut ] setLabel "$imageStackName.filtered3"
"$imageStackName.filtered3" setIconPosition 274 95
"$imageStackName.filtered3" master connect "Remove Small Spots" "ImgOut" 0
"$imageStackName.filtered3" sharedColormap connect "labels.am"
"$imageStackName.filtered3" sharedColormap setDefaultColor 0.8 0.8 0.8
"$imageStackName.filtered3" sharedColormap setDefaultAlpha 0.500000
"$imageStackName.filtered3" sharedColormap activateLocalRange 1
"$imageStackName.filtered3" sharedColormap setLocalMinMax 1.000000 8.000000
"$imageStackName.filtered3" sharedColormap enableAlpha 1
"$imageStackName.filtered3" sharedColormap enableAlphaToggle 1
"$imageStackName.filtered3" sharedColormap setAutoAdjustRangeMode 1
"$imageStackName.filtered3" sharedColormap setColorbarMinMax 1 8
"$imageStackName.filtered3" fire
"$imageStackName.filtered3" primary setIndex 0 0
"$imageStackName.filtered3" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"$imageStackName.filtered3" fire
"$imageStackName.filtered3" setViewerMask 16383
}

set labelAnalysisResults [labelAnalysis "$imageStackName.filtered3" [file tail $cellFolderOutputPath]]
set parametersForShapeAnalysis [lindex $labelAnalysisResults 0]
set imageStackSegmented [lindex $labelAnalysisResults 1]
set imageStackAnalysisFilter [lindex $labelAnalysisResults 2]

set imageStackBoundary [getBoundary $imageStackSegmented]


if {[isDirectoryOrFileExist [file join [file dirname [file dirname $imageStackPath]] segmented $imageStackName\SEG$extension]]} {
	getTBSegmentation $imageStackName $imageStackBoundary [file dirname [file dirname $imageStackPath]] $extension $voxelSizeX $voxelSizeY $voxelSizeZ
}

saveFiles $imageStackName $imageStackBoundary $imageStackSegmented $imageStackAnalysisFilter $cellFolderOutputPath $extension $fileFormat 

"$imageStackName" setNoRemove 1
"$imageStackName" setNoRemoveAll 1
"$imageStackSegmented" setNoRemove 1
"$imageStackSegmented" setNoRemoveAll 1
"$imageStackBoundary" setNoRemove 1
"$imageStackBoundary" setNoRemoveAll 1

remove -all

verificationProject $imageStackName $imageStackBoundary $imageStackSegmented $cellFolderOutputPath

"$imageStackName" setNoRemove 0
"$imageStackName" setNoRemoveAll 0
"$imageStackBoundary" setNoRemove 0
"$imageStackBoundary" setNoRemoveAll 0

remove -all

if {$flags::isEllipsoidFit} {
	set radiusList [ellipsoidFit $imageStackSegmented $cellFolderOutputPath $voxelSizeX $voxelSizeY $voxelSizeZ]
	if {$radiusList != "problem with matlab"} {
		set a [lindex $radiusList 0]
		set b [lindex $radiusList 1]
		set c [lindex $radiusList 2]
		set xc [lindex $radiusList 3]
		set yc [lindex $radiusList 4]
		set zc [lindex $radiusList 5]
		set alpha [lindex $radiusList 6]
		set beta [lindex $radiusList 7]
		set gamma [lindex $radiusList 8]
		set ellipsoidSphericity [lindex $radiusList 9]
		set ellipsoidVolume [lindex $radiusList 10]
		echo $ellipsoidVolume
		set stackVolume [lindex $parametersForShapeAnalysis 1]
		echo $stackVolume
		set extraVolume [expr (($stackVolume/$ellipsoidVolume)-1)*100]
		lappend parametersForShapeAnalysis $a $b $c $xc $yc $zc $alpha $beta $gamma $ellipsoidSphericity $ellipsoidVolume $extraVolume
		writeCSVFile $shapeAnalysisCSVFile $parametersForShapeAnalysis "," "append"
	} else {
		writeCSVFile $shapeAnalysisCSVFile $parametersForShapeAnalysis "," "append"
	}
} else {
	writeCSVFile $shapeAnalysisCSVFile $parametersForShapeAnalysis "," "append"
}


"$imageStackSegmented" setNoRemove 0
"$imageStackSegmented" setNoRemoveAll 0

remove -all
}


#Function called by membrane and scaffold for pre-processing (report p 40-45)
#labelName : name of the label representing the stack in the Avizo project view.
#labelName : name of the label representing the reference stack in the Avizo project view.
proc contrastMatching {labelName labelReferenceImage} {
	#Get the part of the label name before ".". Ex : "image.filtered" -> "image"
	set labelNameSplitted [lindex [split $labelName "."] 0]
	
	#Creation and setup of the z drop correction module (report p 23)
	set hideNewModules 0
	create HxCorrectZDrop "Correct Z Drop 2"
	"Correct Z Drop 2" setIconPosition 55 11
	"Correct Z Drop 2" setVar "CustomHelp" {HxCorrectZDrop}
	#Choose the label to connect to the module
	"Correct Z Drop 2" data connect "$labelName"
	#
	"Correct Z Drop 2" fire
	"Correct Z Drop 2" expression setState {}
	"Correct Z Drop 2" mode setValue 0
	"Correct Z Drop 2" applyTransformToResult 1
	"Correct Z Drop 2" fire
	"Correct Z Drop 2" setViewerMask 16383
	"Correct Z Drop 2" setPickable 1
	
	#Create result
	set hideNewModules 0
	[ {Correct Z Drop 2} create result ] setLabel "$labelNameSplitted.zdrop"
	"$labelNameSplitted.zdrop" setIconPosition 17 45
	"$labelNameSplitted.zdrop" master connect "Correct Z Drop 2" "result" 0
	"$labelNameSplitted.zdrop" sharedColormap disconnect
	"$labelNameSplitted.zdrop" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.zdrop" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.zdrop" sharedColormap activateLocalRange 1
	"$labelNameSplitted.zdrop" sharedColormap setLocalMinMax 0.000000 1.000000
	"$labelNameSplitted.zdrop" sharedColormap enableAlpha 1
	"$labelNameSplitted.zdrop" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.zdrop" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.zdrop" sharedColormap setColorbarMinMax 0 65534
	"$labelNameSplitted.zdrop" fire
	"$labelNameSplitted.zdrop" fire
	"$labelNameSplitted.zdrop" setViewerMask 16383
	
	#Creation and setup of the contrast matching module (report p 24)
	set hideNewModules 0
	create adjustdynamic "Match Contrast"
	"Match Contrast" setIconPosition 421 -29
	"Match Contrast" setVar "CustomHelp" {adjustdynamic.html}
	#Choose the mode "mean and variance". Setting the value to 1 changes the mode to "histogram"
	"Match Contrast" interpretation setValue 0
	"Match Contrast" outputLocation setIndex 0 0
	#Choose the labels to connect to the module
	"Match Contrast" inputImage connect "$labelNameSplitted.zdrop"
	"Match Contrast" referenceImage connect "$labelReferenceImage"
	#
	"Match Contrast" mode setIndex 0 0
	"Match Contrast" applyTransformToResult 1
	"Match Contrast" fire
	"Match Contrast" setViewerMask 16383
	"Match Contrast" setPickable 1
	
	#Create result
	set hideNewModules 0
	[ {Match Contrast} create ImgOut2 ] setLabel "$labelNameSplitted.contrast"
	"$labelNameSplitted.contrast" setIconPosition 578 6
	"$labelNameSplitted.contrast" master connect "Match Contrast" "ImgOut2" 0
	"$labelNameSplitted.contrast" sharedColormap disconnect
	"$labelNameSplitted.contrast" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.contrast" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.contrast" sharedColormap activateLocalRange 1
	"$labelNameSplitted.contrast" sharedColormap setLocalMinMax 0.000000 1.000000
	"$labelNameSplitted.contrast" sharedColormap enableAlpha 1
	"$labelNameSplitted.contrast" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.contrast" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.contrast" sharedColormap setColorbarMinMax 0 65535
	"$labelNameSplitted.contrast" fire
	"$labelNameSplitted.contrast" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$labelNameSplitted.contrast" fire
	"$labelNameSplitted.contrast" setViewerMask 16383
	
	#return the name of the pre-processed label
	return "$labelNameSplitted.contrast"
}

#Function called by membrane and nucleus for post-processing (report p 42)
#labelName : name of the label representing the stack in the Avizo project view.
#structuringElementSize : size of the structuring element used for closing
#flag can be equal to "closing" or ""
#"closing" -> perform a morphological closing using structuringElementSize
#"" -> morphological closing is not performed
proc postProcessing {labelName flag structuringElementSize} {
	#Get the part of the label name before ".". Ex : "image.filtered" -> "image"
	set labelNameSplitted [lindex [split $labelName "."] 0]
	
	#If the argument flag has "closing" as value, perform a morphological closing (report p 26)
	if {$flag == "closing"} {
		#Creation of the closing module
		set hideNewModules 0
		create closing "Closing"
		"Closing" setIconPosition 75 347
		"Closing" setVar "CustomHelp" {closing}
		"Closing" Type setState {type Cube}
		"Closing" interpretation setValue 0
		"Closing" outputLocation setIndex 0 0
		"Closing" neighborhood setValue 2
		#Choose the label to connect to the module
		"Closing" inputImage connect "$labelName"
		#
		"Closing" size setMinMax 0 0 2147483648
		#Set the size of the structuring element 
		"Closing" size setValue 0 $structuringElementSize
		"Closing" applyTransformToResult 1
		"Closing" fire
		"Closing" setViewerMask 16383
		"Closing" setPickable 1
	
		#Create the result
		set hideNewModules 0
		[ {Closing} create ImgOut ] setLabel "$labelNameSplitted.closing"
		"$labelNameSplitted.closing" setIconPosition 20 382
		"$labelNameSplitted.closing" master connect "Closing" "ImgOut" 0
		"$labelNameSplitted.closing" sharedColormap connect "labels.am"
		"$labelNameSplitted.closing" sharedColormap setDefaultColor 0.8 0.8 0.8
		"$labelNameSplitted.closing" sharedColormap setDefaultAlpha 0.500000
		"$labelNameSplitted.closing" sharedColormap activateLocalRange 1
		"$labelNameSplitted.closing" sharedColormap setLocalMinMax 1.000000 8.000000
		"$labelNameSplitted.closing" sharedColormap enableAlpha 1
		"$labelNameSplitted.closing" sharedColormap enableAlphaToggle 1
		"$labelNameSplitted.closing" sharedColormap setAutoAdjustRangeMode 1
		"$labelNameSplitted.closing" sharedColormap setColorbarMinMax 1 8
		"$labelNameSplitted.closing" fire
		"$labelNameSplitted.closing" primary setIndex 0 0
		"$labelNameSplitted.closing" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
		"$labelNameSplitted.closing" fire
		"$labelNameSplitted.closing" setViewerMask 16383
		
		#Fill the holes (report p 27)
		set hideNewModules 0
		create hole_fill2d "Fill Holes"
		"Fill Holes" setIconPosition 333 560
		"Fill Holes" setVar "CustomHelp" {hole_fill2d.html}
		"Fill Holes" interpretation setValue 1
		"Fill Holes" outputLocation setIndex 0 0
		#Choose the label to connect to the module
		"Fill Holes" inputImage connect "$labelNameSplitted.closing"
		#
		"Fill Holes" neighborhoodConnectivity setIndex 0 0
		"Fill Holes" applyTransformToResult 1
		"Fill Holes" fire
		"Fill Holes" setViewerMask 16383
		"Fill Holes" setPickable 1
	#Else directly do the holes filling wihtout doing a closing
	} else {
		set hideNewModules 0
		create hole_fill2d "Fill Holes"
		"Fill Holes" setIconPosition 333 560
		"Fill Holes" setVar "CustomHelp" {hole_fill2d.html}
		"Fill Holes" interpretation setValue 1
		"Fill Holes" outputLocation setIndex 0 0
		"Fill Holes" inputImage connect "$labelName"
		"Fill Holes" neighborhoodConnectivity setIndex 0 0
		"Fill Holes" applyTransformToResult 1
		"Fill Holes" fire
		"Fill Holes" setViewerMask 16383
		"Fill Holes" setPickable 1
	}
	
	#Create the result of Fill Holes
	set hideNewModules 0
	[ {Fill Holes} create ImgOut ] setLabel "$labelNameSplitted.filled"
	"$labelNameSplitted.filled" setIconPosition 333 590
	"$labelNameSplitted.filled" master connect "Fill Holes" "ImgOut" 0
	"$labelNameSplitted.filled" sharedColormap connect "labels.am"
	"$labelNameSplitted.filled" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.filled" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.filled" sharedColormap activateLocalRange 1
	"$labelNameSplitted.filled" sharedColormap setLocalMinMax 1.000000 8.000000
	"$labelNameSplitted.filled" sharedColormap enableAlpha 1
	"$labelNameSplitted.filled" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.filled" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.filled" sharedColormap setColorbarMinMax 1 8
	"$labelNameSplitted.filled" fire
	"$labelNameSplitted.filled" primary setIndex 0 0
	"$labelNameSplitted.filled" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$labelNameSplitted.filled" fire
	"$labelNameSplitted.filled" setViewerMask 16383
	
	#Remove the objects touching the border along x and y axis (report p 28)
	set hideNewModules 0
	create border_kill "Border Kill"
	"Border Kill" setIconPosition 332 620
	"Border Kill" setVar "CustomHelp" {border_kill.html}
	"Border Kill" interpretation setValue 1
	"Border Kill" outputLocation setIndex 0 0
	"Border Kill" neighborhood setValue 2
	#Choose the label to connect to the module
	"Border Kill" inputImage connect "$labelNameSplitted.filled"
	#
	"Border Kill" applyTransformToResult 1
	"Border Kill" fire
	"Border Kill" setViewerMask 16383
	"Border Kill" setPickable 1
	
	#Create result of Border Kill
	set hideNewModules 0
	[ {Border Kill} create ImgOut ] setLabel "$labelNameSplitted.borderKill"
	"$labelNameSplitted.borderKill" setIconPosition 333 650
	"$labelNameSplitted.borderKill" master connect "Border Kill" "ImgOut" 0
	"$labelNameSplitted.borderKill" sharedColormap connect "labels.am"
	"$labelNameSplitted.borderKill" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.borderKill" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.borderKill" sharedColormap activateLocalRange 1
	"$labelNameSplitted.borderKill" sharedColormap setLocalMinMax 1.000000 8.000000
	"$labelNameSplitted.borderKill" sharedColormap enableAlpha 1
	"$labelNameSplitted.borderKill" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.borderKill" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.borderKill" sharedColormap setColorbarMinMax 1 8
	"$labelNameSplitted.borderKill" fire
	"$labelNameSplitted.borderKill" primary setIndex 0 0
	"$labelNameSplitted.borderKill" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$labelNameSplitted.borderKill" fire
	"$labelNameSplitted.borderKill" setViewerMask 16383
	
	#Remove the small objects (report p 28)
	set hideNewModules 0
	create removalsmallspots "Remove Small Spots"
	"Remove Small Spots" setIconPosition 334 680
	"Remove Small Spots" setVar "CustomHelp" {removalsmallspots.html}
	"Remove Small Spots" interpretation setValue 0
	"Remove Small Spots" outputLocation setIndex 0 0
	#Choose the label to connect to the module
	"Remove Small Spots" inputImage connect "$labelNameSplitted.borderKill"
	#
	"Remove Small Spots" size setMinMax 0 0 3.40282346638529e+038
	"Remove Small Spots" size setValue 0 10000
	"Remove Small Spots" applyTransformToResult 1
	"Remove Small Spots" fire
	"Remove Small Spots" setViewerMask 16383
	"Remove Small Spots" setPickable 1
	
	#Create result
	set hideNewModules 0
	[ {Remove Small Spots} create ImgOut ] setLabel "$labelNameSplitted.filtered3"
	"$labelNameSplitted.filtered3" setIconPosition 334 710
	"$labelNameSplitted.filtered3" master connect "Remove Small Spots" "ImgOut" 0
	"$labelNameSplitted.filtered3" sharedColormap connect "labels.am"
	"$labelNameSplitted.filtered3" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.filtered3" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.filtered3" sharedColormap activateLocalRange 1
	"$labelNameSplitted.filtered3" sharedColormap setLocalMinMax 1.000000 8.000000
	"$labelNameSplitted.filtered3" sharedColormap enableAlpha 1
	"$labelNameSplitted.filtered3" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.filtered3" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.filtered3" sharedColormap setColorbarMinMax 1 8
	"$labelNameSplitted.filtered3" fire
	"$labelNameSplitted.filtered3" primary setIndex 0 0
	"$labelNameSplitted.filtered3" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$labelNameSplitted.filtered3" fire
	"$labelNameSplitted.filtered3" setViewerMask 16383
	
	#Return the label name of the post processed stack
	return "$labelNameSplitted.filtered3"
}

#Function called by membrane, nucleus and scaffold for extracting parameters (report p 28)
#labelName : name of the label representing the stack in the Avizo project view.
#rowHeader : name of the cell folder, to be added with the rest of the parameters in global CSV file. Ex : "B0_avizoOuput"
proc labelAnalysis {labelName rowHeader} {
	#Get the part of the label name before ".". Ex : "image.filtered" -> "image"
	set labelNameSplitted [lindex [split $labelName "."] 0]
	
	if 1 {
	#Create a label analysis module to extract parameters in a table (report p 28)
	set hideNewModules 0
	create HxAnalyzeLabels "Label Analysis"
	"Label Analysis" setIconPosition 470 243
	"Label Analysis" setVar "CustomHelp" {HxAnalyzeLabels}
	#Choose the label to connect to the module
	"Label Analysis" data connect "$labelName"
	#
	"Label Analysis" fire
	"Label Analysis" interpretation setValue 0
	"Label Analysis" sequenceMode setValue 0
	#Create custom measurements. They are defined by a code. Save a project using this measure to get the code.
	labelMeasure scheduleRestore "{42bb78e0-72ae-4605-bd01-13218b856edb}" "finalDist" 5 "( BaryCenterX - cx*gx/2)**2 + ( BaryCenterY - cy*gy/2)**2 + (BaryCenterZ - cz*gz/2)**2"
	labelMeasure scheduleRestore "{c449ffd7-8108-416b-8c15-86a06391a9b6}" "SVratio" 5 "Area3d/ Volume3d  "
	labelMeasure processScheduledRestore
	labelMeasure setAttributes feret2d 0 18 36 54 72 90 108 126 144 162
	labelMeasure setAttributes feret3d 31
	labelMeasure setAttributes cooccurrence 0 0
	labelMeasure setAttributes histogram 1 0 255 1
	labelMeasure setAttributes quantile 0.1 0.1 0.1 0.1 0.1 0.1
	labelMeasure setAttributes breadth3d 10
	#Set the parameters to be extracted
	"Label Analysis" measures setState {"segGroup" {42bb78e0-72ae-4605-bd01-13218b856edb} Volume3d Breadth3d Area3d Shape_VA3d Thickness3d Anisotropy Perimeter FeretShape3d Length3d Width3d BreadthOrientPhi BreadthOrientTheta LengthOrientPhi LengthOrientTheta WidthOrientPhi WidthOrientTheta Area AreaFraction BorderVoxelCount CroftonPerimeter EqDiameter Euler3D IntegralMeanCurvature IntegralTotalCurvature Orientation2Phi Orientation2Theta OrientationPhi OrientationTheta Volume Volume2 VoxelFaceArea Elongation Flatness BoundingBoxDx BoundingBoxDy BoundingBoxDz BinMom2x BinMom2y BinMom2z BinMomxy BinMomxz BinMomyz EigenVal1 EigenVal2 EigenVal3 EigenVec1X EigenVec1Y EigenVec1Z EigenVec2X EigenVec2Y EigenVec2Z EigenVec3X EigenVec3Y EigenVec3Z ExtentMax1 ExtentMax2 ExtentMax3 ExtentMin1 ExtentMin2 ExtentMin3 {c449ffd7-8108-416b-8c15-86a06391a9b6}}
	"Label Analysis" showAnalysis setValue 0 1
	"Label Analysis" showAnalysis setToggleVisible 0 1
	"Label Analysis" applyTransformToResult 1
	"Label Analysis" fire
	"Label Analysis" setViewerMask 16383
	"Label Analysis" setPickable 1
	
	#Create the resulting stack
	set hideNewModules 0
	[ {Label Analysis} create AnlOut ] setLabel "$labelNameSplitted.Label-Analysis"
	"$labelNameSplitted.Label-Analysis" setIconPosition 20 279
	"$labelNameSplitted.Label-Analysis" master connect "Label Analysis" "AnlOut" 0
	"$labelNameSplitted.Label-Analysis" fire
	"$labelNameSplitted.Label-Analysis" fire
	"$labelNameSplitted.Label-Analysis" setViewerMask 16383
	
	#Create the resulting table containing the parameters
	set hideNewModules 0
	[ {Label Analysis} create ImgOutLab ] setLabel "$labelNameSplitted.label"
	"$labelNameSplitted.label" setIconPosition 20 243
	"$labelNameSplitted.label" master connect "Label Analysis" "ImgOutLab" 1
	"$labelNameSplitted.label" sharedColormap connect "labels.am"
	"$labelNameSplitted.label" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.label" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.label" sharedColormap activateLocalRange 1
	"$labelNameSplitted.label" sharedColormap setLocalMinMax 1.000000 8.000000
	"$labelNameSplitted.label" sharedColormap enableAlpha 1
	"$labelNameSplitted.label" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.label" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.label" fire
	"$labelNameSplitted.label" primary setIndex 0 0
	"$labelNameSplitted.label" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$labelNameSplitted.label" fire
	"$labelNameSplitted.label" setViewerMask 16383
	}

	#In case a error occurs when trying to modify the digit precision of the table, it means the table is empty.
	#COnsequently, the project view is cleaned adn the label analysis is stopped
	if {[catch {"$labelNameSplitted.Label-Analysis" setNumPrecisionCol 1 8}]} {
		remove -all
		return
	}

	if 1 {
	#Set a small value
	set antiRoundError 0.1
	#Get the number of rows. Each row represent an object
	set numRows ["$labelNameSplitted.Label-Analysis" getNumRows]
	#Get all the values of column 61 in a list. This column contains the distance to the center 
	set rows [list]
	for {set i 0} {$i<$numRows} {incr i} {
		lappend rows ["$labelNameSplitted.Label-Analysis" getValue 60 $i]
	}
	#Get the minimum distance
	set rowsSorted [lsort -real $rows]
	echo $rowsSorted
	set objectDistance [lindex $rowsSorted 0]
	set limMin [expr $objectDistance - $antiRoundError]
	set limMax [expr $objectDistance + $antiRoundError]
	
	#Extract only the object having the minimum distance
	set hideNewModules 0
	create HxFilterAnalysis "Analysis Filter"
	"Analysis Filter" setIconPosition 160 315
	"Analysis Filter" setVar "CustomHelp" {HxFilterAnalysis}
	"Analysis Filter" data connect "$labelNameSplitted.Label-Analysis"
	"Analysis Filter" image connect "$labelNameSplitted.label"
	"Analysis Filter" fire
	"Analysis Filter" filter setState "finalDist < $limMax && finalDist > $limMin"
	"Analysis Filter" showAnalysis setValue 0 1
	"Analysis Filter" showAnalysis setToggleVisible 0 1
	"Analysis Filter" applyTransformToResult 1
	"Analysis Filter" fire
	"Analysis Filter" setViewerMask 16383
	"Analysis Filter" setPickable 1
	
	#Create a new table containing only the object with the minimum distance
	set hideNewModules 0
	[ {Analysis Filter} create AnlOut ] setLabel "$labelNameSplitted.Analysis-Filter"
	"$labelNameSplitted.Analysis-Filter" setIconPosition 20 351
	"$labelNameSplitted.Analysis-Filter" master connect "Analysis Filter" "AnlOut" 0
	"$labelNameSplitted.Analysis-Filter" fire
	"$labelNameSplitted.Analysis-Filter" fire
	"$labelNameSplitted.Analysis-Filter" setViewerMask 16383
	}
	
	#In case the old table was empty, the associated stack was an empty stack.
	#Consequently, creating a new stack from an empty stack throws an error.
	#In that case, the project view is cleaned and the label analysis is stopped
	set hideNewModules 0
	if {[catch {[ {Analysis Filter} create result1 ] setLabel "$labelNameSplitted.label-filtering"}]} {
		remove -all
		return
	}

	if 1 {
	"$labelNameSplitted.label-filtering" setIconPosition 20 387
	"$labelNameSplitted.label-filtering" master connect "Analysis Filter" "result1" 1
	"$labelNameSplitted.label-filtering" sharedColormap connect "labels.am"
	"$labelNameSplitted.label-filtering" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.label-filtering" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.label-filtering" sharedColormap activateLocalRange 1
	"$labelNameSplitted.label-filtering" sharedColormap setLocalMinMax 1.000000 8.000000
	"$labelNameSplitted.label-filtering" sharedColormap enableAlpha 1
	"$labelNameSplitted.label-filtering" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.label-filtering" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.label-filtering" sharedColormap setColorbarMinMax 1 8
	"$labelNameSplitted.label-filtering" fire
	"$labelNameSplitted.label-filtering" primary setIndex 0 0
	"$labelNameSplitted.label-filtering" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$labelNameSplitted.label-filtering" fire
	"$labelNameSplitted.label-filtering" setViewerMask 16383
	
	######################## #Conversion of the type of the stack from 8 to 16 bits (maybe unecessary) #########################################
	set hideNewModules 0
	create HxCastField "Convert Image Type"
	"Convert Image Type" setIconPosition 311 199
	"Convert Image Type" setVar "CustomHelp" {HxCastField}
	"Convert Image Type" data connect "$labelNameSplitted.label-filtering"
	"Convert Image Type" colormap connect "labels.am"
	"Convert Image Type" colormap setDefaultColor 1 0.8 0.5
	"Convert Image Type" colormap setDefaultAlpha 0.500000
	"Convert Image Type" colormap activateLocalRange 1
	"Convert Image Type" colormap setLocalMinMax 1.000000 8.000000
	"Convert Image Type" colormap enableAlpha 1
	"Convert Image Type" colormap enableAlphaToggle 1
	"Convert Image Type" colormap setAutoAdjustRangeMode 1
	"Convert Image Type" colormap setColorbarMinMax 1 8
	"Convert Image Type" fire
	"Convert Image Type" outputType setIndex 0 2
	"Convert Image Type" scaling setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
	"Convert Image Type" scaling setValue 0 1
	"Convert Image Type" scaling setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
	"Convert Image Type" scaling setValue 1 0
	"Convert Image Type" voxelGridOptions setValue 0 1
	"Convert Image Type" voxelGridOptions setToggleVisible 0 1
	"Convert Image Type" colorFieldOptions setIndex 0 0
	"Convert Image Type" applyTransformToResult 1
	"Convert Image Type" fire
	"Convert Image Type" setViewerMask 16383
	"Convert Image Type" setPickable 1

	set hideNewModules 0
	[ {Convert Image Type} create result ] setLabel "$labelNameSplitted.to-ushort"
	"$labelNameSplitted.to-ushort" setIconPosition 278 227
	"$labelNameSplitted.to-ushort" master connect "Convert Image Type" "result" 0
	"$labelNameSplitted.to-ushort" sharedColormap connect "labels.am"
	"$labelNameSplitted.to-ushort" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.to-ushort" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.to-ushort" sharedColormap activateLocalRange 1
	"$labelNameSplitted.to-ushort" sharedColormap setLocalMinMax 1.000000 8.000000
	"$labelNameSplitted.to-ushort" sharedColormap enableAlpha 1
	"$labelNameSplitted.to-ushort" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.to-ushort" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.to-ushort" sharedColormap setColorbarMinMax 1 8
	"$labelNameSplitted.to-ushort" fire
	"$labelNameSplitted.to-ushort" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$labelNameSplitted.to-ushort" fire
	"$labelNameSplitted.to-ushort" setViewerMask 16383

	set hideNewModules 0
	create HxInteractiveThreshold "Interactive Thresholding"
	"Interactive Thresholding" setViewerMask 0
	"Interactive Thresholding" setIconPosition 290 260
	"Interactive Thresholding" setVar "CustomHelp" {HxInteractiveThreshold}
	set hideNewModules 0

	"Interactive Thresholding" data connect "$labelNameSplitted.to-ushort"
	"Interactive Thresholding" inputColorMap connect "labels.am"
	"Interactive Thresholding" inputColorMap setDefaultColor 1 0.8 0.5
	"Interactive Thresholding" inputColorMap setDefaultAlpha 0.500000
	"Interactive Thresholding" inputColorMap activateLocalRange 1
	"Interactive Thresholding" inputColorMap setLocalMinMax 1.000000 8.000000
	"Interactive Thresholding" inputColorMap enableAlpha 1
	"Interactive Thresholding" inputColorMap enableAlphaToggle 1
	"Interactive Thresholding" inputColorMap setAutoAdjustRangeMode 1
	"Interactive Thresholding" inputColorMap setColorbarMinMax 1 8
	"Interactive Thresholding" fire
	"Interactive Thresholding" preview setValue 0 1
	"Interactive Thresholding" preview setToggleVisible 0 1
	"Interactive Thresholding" preview setValue 1 0
	"Interactive Thresholding" preview setToggleVisible 1 1
	"Interactive Thresholding" orientation setValue 0
	"Interactive Thresholding" sliceNumber setMinMax 0 360
	"Interactive Thresholding" sliceNumber setButtons 1
	"Interactive Thresholding" sliceNumber setEditButton 1
	"Interactive Thresholding" sliceNumber setIncrement 1
	"Interactive Thresholding" sliceNumber setValue 180
	"Interactive Thresholding" sliceNumber setSubMinMax 0 360
	"Interactive Thresholding" rendering setValue 1
	"Interactive Thresholding" intensityRange setMinMax 0 65535
	"Interactive Thresholding" intensityRange setValues 1 255
	"Interactive Thresholding" intensityRange setButtons 0
	"Interactive Thresholding" intensityRange setEditButton 1
	"Interactive Thresholding" intensityRange setIncrement 4369
	"Interactive Thresholding" intensityRange setSubMinMax 0 0
	"Interactive Thresholding" colorMask setColor 0 0 0 1
	"Interactive Thresholding" applyTransformToResult 1
	"Interactive Thresholding" fire
	"Interactive Thresholding" setViewerMask 16382
	"Interactive Thresholding" setPickable 1

	set hideNewModules 0
	[ {Interactive Thresholding} create result ] setLabel "$labelNameSplitted.processed"
	"$labelNameSplitted.processed" setIconPosition 268 290
	"$labelNameSplitted.processed" master connect "Interactive Thresholding" "result" 0
	"$labelNameSplitted.processed" sharedColormap connect "labels.am"
	"$labelNameSplitted.processed" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.processed" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.processed" sharedColormap activateLocalRange 1
	"$labelNameSplitted.processed" sharedColormap setLocalMinMax 1.000000 8.000000
	"$labelNameSplitted.processed" sharedColormap enableAlpha 1
	"$labelNameSplitted.processed" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.processed" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.processed" sharedColormap setColorbarMinMax 1 8
	"$labelNameSplitted.processed" fire
	"$labelNameSplitted.processed" primary setIndex 0 0
	"$labelNameSplitted.processed" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$labelNameSplitted.processed" fire
	"$labelNameSplitted.processed" setViewerMask 16383
	
	# ##############################################################################################
	}
	
	#Create a list of all the parameters contained in the final table. The variable rowHeader is used to save the name of cell with the parameters
	set parametersForShapeAnalysis [list $rowHeader ["$labelNameSplitted.Analysis-Filter" getValue 0 0] ["$labelNameSplitted.Analysis-Filter" getValue 1 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 2 0] ["$labelNameSplitted.Analysis-Filter" getValue 3 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 4 0] ["$labelNameSplitted.Analysis-Filter" getValue 5 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 6 0] ["$labelNameSplitted.Analysis-Filter" getValue 7 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 8 0] ["$labelNameSplitted.Analysis-Filter" getValue 9 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 10 0] ["$labelNameSplitted.Analysis-Filter" getValue 11 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 12 0] ["$labelNameSplitted.Analysis-Filter" getValue 13 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 14 0] ["$labelNameSplitted.Analysis-Filter" getValue 15 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 16 0] ["$labelNameSplitted.Analysis-Filter" getValue 17 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 18 0] ["$labelNameSplitted.Analysis-Filter" getValue 19 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 20 0] ["$labelNameSplitted.Analysis-Filter" getValue 21 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 22 0] ["$labelNameSplitted.Analysis-Filter" getValue 23 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 24 0] ["$labelNameSplitted.Analysis-Filter" getValue 25 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 26 0] ["$labelNameSplitted.Analysis-Filter" getValue 27 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 28 0] ["$labelNameSplitted.Analysis-Filter" getValue 29 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 30 0] ["$labelNameSplitted.Analysis-Filter" getValue 31 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 32 0] ["$labelNameSplitted.Analysis-Filter" getValue 33 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 34 0] ["$labelNameSplitted.Analysis-Filter" getValue 35 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 36 0] ["$labelNameSplitted.Analysis-Filter" getValue 37 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 38 0] ["$labelNameSplitted.Analysis-Filter" getValue 39 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 40 0] ["$labelNameSplitted.Analysis-Filter" getValue 41 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 42 0] ["$labelNameSplitted.Analysis-Filter" getValue 43 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 44 0] ["$labelNameSplitted.Analysis-Filter" getValue 45 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 46 0] ["$labelNameSplitted.Analysis-Filter" getValue 47 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 48 0] ["$labelNameSplitted.Analysis-Filter" getValue 49 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 50 0] ["$labelNameSplitted.Analysis-Filter" getValue 51 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 52 0] ["$labelNameSplitted.Analysis-Filter" getValue 53 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 54 0] ["$labelNameSplitted.Analysis-Filter" getValue 55 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 56 0] ["$labelNameSplitted.Analysis-Filter" getValue 57 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 58 0] ["$labelNameSplitted.Analysis-Filter" getValue 59 0] \
	["$labelNameSplitted.Analysis-Filter" getValue 61 0]]

	#return the list of parameters, the label name of the processed stack, the table containing the parameters
	return [list $parametersForShapeAnalysis "$labelNameSplitted.processed" "$labelNameSplitted.Analysis-Filter"]
}

#Function called by membrane, nucleus and scaffold to get the boundary of a stack (report p 26-42)
#labelName : name of the label representing the stack in the Avizo project view.
proc getBoundary {labelName} {
	set labelNameSplitted [lindex [split $labelName "."] 0]
	
	#Extract the boundary of a stack
	set hideNewModules 0
	create boundary "Label Boundaries"
	"Label Boundaries" setIconPosition 380 -5
	"Label Boundaries" setVar "CustomHelp" {boundary.html}
	"Label Boundaries" interpretation setValue 0
	"Label Boundaries" outputLocation setIndex 0 0
	#Choose the label to connect to the module
	"Label Boundaries" inputImage connect "$labelName"
	"Label Boundaries" applyTransformToResult 1
	"Label Boundaries" fire
	"Label Boundaries" setViewerMask 16383
	"Label Boundaries" setPickable 1
	
	#Create the result
	set hideNewModules 0
	[ {Label Boundaries} create ImgOut ] setLabel "$labelNameSplitted.boundary"
	"$labelNameSplitted.boundary" setIconPosition 375 30
	"$labelNameSplitted.boundary" master connect "Label Boundaries" "ImgOut" 0
	"$labelNameSplitted.boundary" sharedColormap connect "labels.am"
	"$labelNameSplitted.boundary" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$labelNameSplitted.boundary" sharedColormap setDefaultAlpha 0.500000
	"$labelNameSplitted.boundary" sharedColormap activateLocalRange 1
	"$labelNameSplitted.boundary" sharedColormap setLocalMinMax 1.000000 8.000000
	"$labelNameSplitted.boundary" sharedColormap enableAlpha 1
	"$labelNameSplitted.boundary" sharedColormap enableAlphaToggle 1
	"$labelNameSplitted.boundary" sharedColormap setAutoAdjustRangeMode 1
	"$labelNameSplitted.boundary" sharedColormap setColorbarMinMax 1 8
	"$labelNameSplitted.boundary" fire
	"$labelNameSplitted.boundary" primary setIndex 0 0
	"$labelNameSplitted.boundary" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$labelNameSplitted.boundary" fire
	"$labelNameSplitted.boundary" setViewerMask 16383
	
	#Return the label name of the boundary stack
	return "$labelNameSplitted.boundary"
}

#Function called by membrane, nucleus and scaffold to save stacks, project files, CSV files... (report p 37-38-42)
#imageStackName : name of the label representing the initial stack in the Avizo project view.
#imageStackBoundary : name of the label representing the boundary stack in the Avizo project view.
#imageStackProcessed : name of the label representing the processed stack in the Avizo project view.
#imageStackAnalysisFilter : name of the label representing the Avizo table containing the parameters in the Avizo project view.
#cellFolderOutputPath : Path to the output cell folder. Ex : "D:/Valentin/outputs/avizoOutput"
#extension : extension of the stacks. Ex : ".tif"
#fileFormat : file format used to save the stacks. Ex : "3D Tiff"
proc saveFiles {imageStackName imageStackBoundary imageStackProcessed imageStackAnalysisFilter cellFolderOutputPath extension fileFormat} {
	#Set paths to the different output folders
	set fileBoundary [file join $cellFolderOutputPath boundary $imageStackName\_boundary$extension]
	set fileProcessed [file join $cellFolderOutputPath segmented $imageStackName\_segmented$extension]
	set fileAnalysisFilter [file join $cellFolderOutputPath csvFiles $imageStackName\.csv]
	set projectDirectory [file join $cellFolderOutputPath hxFiles]
	
	#Save the boundary stack
	saveDataToFile $fileBoundary $fileFormat $imageStackBoundary
	#Save the processed stack
	saveDataToFile $fileProcessed $fileFormat $imageStackProcessed
	#Save the parameters in a CSV file (different from the global CSV files)
	saveDataToFile $fileAnalysisFilter "CSV" $imageStackAnalysisFilter
	#Save the project file
	saveProjectFiles $projectDirectory $imageStackName
}

#Function called by membrane, nucleus and scaffold to save a ".hx" file for verification (report p 37-38-42)
#imageStackName : name of the label representing the initial stack in the Avizo project view.
#imageStackBoundary : name of the label representing the boundary stack in the Avizo project view.
#imageStackProcessed : name of the label representing the processed stack in the Avizo project view.
#cellFolderOutputPath : Path to the output cell folder. Ex : "D:/Valentin/outputs/avizoOutput"
proc verificationProject {imageStackName imageStackBoundary imageStackProcessed cellFolderOutputPath} {
#Create ortho slice and color wash modules to overlap the boundary on the initial stack
if 1 {
set hideNewModules 0
create HxOrthoSlice "Ortho Slice"
"Ortho Slice" setIconPosition 681 912
"Ortho Slice" setVar "CustomHelp" {HxOrthoSlice}
#Connect ortho slice to the label representing the initial stack
"Ortho Slice" data connect "$imageStackName"
"Ortho Slice" fire
"Ortho Slice" sliceOrientation setValue 0
"Ortho Slice" fire
"Ortho Slice" origin  setBoundingBox -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038
"Ortho Slice" origin  setImmediateMode 0
"Ortho Slice" origin  setOrtho 0
"Ortho Slice" origin  showDragger 0
"Ortho Slice" origin  showPoints 0
"Ortho Slice" origin  setPointScale 1
"Ortho Slice" origin  showOptionButton 58
"Ortho Slice" origin  setNumPoints 1 1 1
"Ortho Slice" origin  setCoord 0 52.208 52.104 28.2564
"Ortho Slice" normal  setBoundingBox -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038
"Ortho Slice" normal  setImmediateMode 0
"Ortho Slice" normal  setOrtho 0
"Ortho Slice" normal  showDragger 0
"Ortho Slice" normal  showPoints 0
"Ortho Slice" normal  setPointScale 1
"Ortho Slice" normal  showOptionButton 114
"Ortho Slice" normal  setNumPoints 1 1 1
"Ortho Slice" normal  setCoord 0 0 0 1
"Ortho Slice" options setValue 0 1
"Ortho Slice" options setToggleVisible 0 1
"Ortho Slice" options setValue 1 0
"Ortho Slice" options setToggleVisible 1 1
"Ortho Slice" options setValue 2 0
"Ortho Slice" options setToggleVisible 2 1
"Ortho Slice" mappingType setIndex 0 0
"Ortho Slice" contrastLimit setMinMax 0 -16777216 16777216
"Ortho Slice" contrastLimit setValue 0 7
"Ortho Slice" colormap connect "grayScale.am"
"Ortho Slice" colormap setDefaultColor 1 0.8 0.5
"Ortho Slice" colormap setDefaultAlpha 1.000000
"Ortho Slice" colormap activateLocalRange 1
"Ortho Slice" colormap setLocalMinMax 0.000000 1795.000000
"Ortho Slice" colormap enableAlpha 1
"Ortho Slice" colormap enableAlphaToggle 1
"Ortho Slice" colormap setAutoAdjustRangeMode 1
"Ortho Slice" colormap setColorbarMinMax 0 65534
"Ortho Slice" sliceNumber setMinMax 0 500
"Ortho Slice" sliceNumber setButtons 1
"Ortho Slice" sliceNumber setEditButton 1
"Ortho Slice" sliceNumber setIncrement 1
"Ortho Slice" sliceNumber setValue 282
"Ortho Slice" sliceNumber setSubMinMax 0 500
"Ortho Slice" transparency setValue 0
"Ortho Slice" alpha setMinMax 0 -16777216 16777216
"Ortho Slice" alpha setValue 0 0
"Ortho Slice" alpha setMinMax 1 -16777216 16777216
"Ortho Slice" alpha setValue 1 255
"Ortho Slice" frameSettings setState {item 0 1 item 2 1 color 3 1 0.5 0 }
"Ortho Slice" embossingOnOff setValue 0
"Ortho Slice" depth setMinMax -60 60
"Ortho Slice" depth setButtons 0
"Ortho Slice" depth setEditButton 1
"Ortho Slice" depth setIncrement 8
"Ortho Slice" depth setValue 2
"Ortho Slice" depth setSubMinMax -60 60
"Ortho Slice" fire

"Ortho Slice" fire
"Ortho Slice" setViewerMask 16383
"Ortho Slice" setShadowStyle 0
"Ortho Slice" setPickable 1

set hideNewModules 0
create HxColorwash "Color Wash"
"Color Wash" setIconPosition 681 938
"Color Wash" setVar "CustomHelp" {HxColorwash}
#Connect color wash to the label representing the boundary stack
"Color Wash" data connect "$imageStackBoundary"
"Color Wash" module connect "Ortho Slice"
"Color Wash" colormap connect "labels.am"
"Color Wash" colormap setDefaultColor 1 0.8 0.5
"Color Wash" colormap setDefaultAlpha 0.500000
"Color Wash" colormap activateLocalRange 1
"Color Wash" colormap setLocalMinMax 1.000000 8.000000
"Color Wash" colormap enableAlpha 1
"Color Wash" colormap enableAlphaToggle 1
"Color Wash" colormap setAutoAdjustRangeMode 1
"Color Wash" colormap setColorbarMinMax 1 8
"Color Wash" fire
"Color Wash" mode setIndex 0 7
"Color Wash" weightFactor setMinMax 0 1
"Color Wash" weightFactor setButtons 0
"Color Wash" weightFactor setEditButton 1
"Color Wash" weightFactor setIncrement 0.1
"Color Wash" weightFactor setValue 0.5
"Color Wash" weightFactor setSubMinMax 0 1
"Color Wash" lenseWidth setMinMax 5 80
"Color Wash" lenseWidth setButtons 1
"Color Wash" lenseWidth setEditButton 1
"Color Wash" lenseWidth setIncrement 1
"Color Wash" lenseWidth setValue 30
"Color Wash" lenseWidth setSubMinMax 5 80
"Color Wash" overlayRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Color Wash" overlayRange setValue 0 100
"Color Wash" overlayRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Color Wash" overlayRange setValue 1 1000
"Color Wash" transparency setMinMax 0 1
"Color Wash" transparency setButtons 0
"Color Wash" transparency setEditButton 1
"Color Wash" transparency setIncrement 0.1
"Color Wash" transparency setValue 0.3
"Color Wash" transparency setSubMinMax 0 1
"Color Wash" options setValue 0 0
"Color Wash" options setToggleVisible 0 1
"Color Wash" options setValue 1 1
"Color Wash" options setToggleVisible 1 1
"Color Wash" generalOptions setValue 0 0
"Color Wash" generalOptions setToggleVisible 0 1
"Color Wash" fire
"Color Wash" setViewerMask 16383
"Color Wash" setPickable 1

set hideNewModules 0
create HxOrthoSlice "Ortho Slice 2"
"Ortho Slice 2" setIconPosition 435 221
"Ortho Slice 2" setVar "CustomHelp" {HxOrthoSlice}
#Connect the second ortho slice to the label representing the processed stack
"Ortho Slice 2" data connect "$imageStackProcessed"
"Ortho Slice 2" fire
"Ortho Slice 2" sliceOrientation setValue 0
"Ortho Slice 2" fire
"Ortho Slice 2" origin  setBoundingBox -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038
"Ortho Slice 2" origin  setImmediateMode 0
"Ortho Slice 2" origin  setOrtho 0
"Ortho Slice 2" origin  showDragger 0
"Ortho Slice 2" origin  showPoints 0
"Ortho Slice 2" origin  setPointScale 1
"Ortho Slice 2" origin  showOptionButton 1
"Ortho Slice 2" origin  setNumPoints 1 1 1
"Ortho Slice 2" origin  setCoord 0 52.208 52.104 14.3409
"Ortho Slice 2" normal  setBoundingBox -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038
"Ortho Slice 2" normal  setImmediateMode 0
"Ortho Slice 2" normal  setOrtho 0
"Ortho Slice 2" normal  showDragger 0
"Ortho Slice 2" normal  showPoints 0
"Ortho Slice 2" normal  setPointScale 1
"Ortho Slice 2" normal  showOptionButton 1
"Ortho Slice 2" normal  setNumPoints 1 1 1
"Ortho Slice 2" normal  setCoord 0 0 0 1
"Ortho Slice 2" options setValue 0 0
"Ortho Slice 2" options setToggleVisible 0 1
"Ortho Slice 2" options setValue 1 0
"Ortho Slice 2" options setToggleVisible 1 1
"Ortho Slice 2" options setValue 2 0
"Ortho Slice 2" options setToggleVisible 2 1
"Ortho Slice 2" mappingType setIndex 0 0
"Ortho Slice 2" contrastLimit setMinMax 0 -16777216 16777216
"Ortho Slice 2" contrastLimit setValue 0 7
"Ortho Slice 2" colormap connect "labels.am"
"Ortho Slice 2" colormap setDefaultColor 1 0.8 0.5
"Ortho Slice 2" colormap setDefaultAlpha 1.000000
"Ortho Slice 2" colormap activateLocalRange 1
"Ortho Slice 2" colormap setLocalMinMax 1.000000 8.000000
"Ortho Slice 2" colormap enableAlpha 1
"Ortho Slice 2" colormap enableAlphaToggle 1
"Ortho Slice 2" colormap setAutoAdjustRangeMode 1
"Ortho Slice 2" colormap setColorbarMinMax 1 8
"Ortho Slice 2" sliceNumber setMinMax 0 350
"Ortho Slice 2" sliceNumber setButtons 1
"Ortho Slice 2" sliceNumber setEditButton 1
"Ortho Slice 2" sliceNumber setIncrement 1
"Ortho Slice 2" sliceNumber setValue 143
"Ortho Slice 2" sliceNumber setSubMinMax 0 350
"Ortho Slice 2" transparency setValue 0
"Ortho Slice 2" alpha setMinMax 0 -16777216 16777216
"Ortho Slice 2" alpha setValue 0 0
"Ortho Slice 2" alpha setMinMax 1 -16777216 16777216
"Ortho Slice 2" alpha setValue 1 255
"Ortho Slice 2" frameSettings setState {item 0 1 item 2 1 color 3 1 0.5 0 }
"Ortho Slice 2" embossingOnOff setValue 0
"Ortho Slice 2" depth setMinMax -60 60
"Ortho Slice 2" depth setButtons 0
"Ortho Slice 2" depth setEditButton 1
"Ortho Slice 2" depth setIncrement 8
"Ortho Slice 2" depth setValue 2
"Ortho Slice 2" depth setSubMinMax -60 60
"Ortho Slice 2" fire

"Ortho Slice 2" fire
"Ortho Slice 2" setViewerMask 16383
"Ortho Slice 2" select
"Ortho Slice 2" setShadowStyle 0
"Ortho Slice 2" setPickable 1
}

#Set the path to the verification folder
set verificationDirectory [file join $cellFolderOutputPath verification]

#Save the project project file
#Show the properties window before saving to directly have the properties available on the screen when launching the verification ".hx" file
theProperties show
saveProjectFiles $verificationDirectory $imageStackName\_verification
theProperties hide
}

#Function called by membrane, nucleus and scaffold to save a ".hx" file for ellipsoid fit (report p 37-38-43)
#cellFolderOutputPath : Path to the output cell folder. Ex : "D:/Valentin/outputs/avizoOutput"
proc ellipsoidFit {labelName cellFolderOutputPath voxelSizeX voxelSizeY voxelSizeZ} {

if 1 {
#Display a volume rendering of the stack represented by the variable label name
set hideNewModules 0
create HxVolumeRenderingSettings "Volume Rendering Settings"
"Volume Rendering Settings" setIconPosition 365 46
"Volume Rendering Settings" setVar "CustomHelp" {HxVolumeRenderingSettings}
"Volume Rendering Settings" data connect "$labelName"
"Volume Rendering Settings" fire
"Volume Rendering Settings" interpolationAdvanced setValue 0
"Volume Rendering Settings" composition setValue 0
"Volume Rendering Settings" quality setValue 1
"Volume Rendering Settings" fire
"Volume Rendering Settings" options setValue 0 0
"Volume Rendering Settings" options setToggleVisible 0 1
"Volume Rendering Settings" options setValue 1 0
"Volume Rendering Settings" options setToggleVisible 1 1
"Volume Rendering Settings" lighting setState {item 0 1 item 1 1 }
"Volume Rendering Settings" gradient setState {item 0 1 item 2 9.99999974737875e-05 }
"Volume Rendering Settings" effects setValue 0 0
"Volume Rendering Settings" effects setToggleVisible 0 1
"Volume Rendering Settings" effects setValue 1 0
"Volume Rendering Settings" effects setToggleVisible 1 1
"Volume Rendering Settings" effects setValue 2 0
"Volume Rendering Settings" effects setToggleVisible 2 1
"Volume Rendering Settings" effects setValue 3 1
"Volume Rendering Settings" effects setToggleVisible 3 1
"Volume Rendering Settings" ambientOcclusion setValue 0 1
"Volume Rendering Settings" ambientOcclusion setToggleVisible 0 1
"Volume Rendering Settings" edgeEnhancement setState {item 0 0 item 2 9.99999974737875e-05 }
"Volume Rendering Settings" edge2D setState {item 0 0 item 2 0.100000001490116 item 4 0.100000001490116 item 6 1 }
"Volume Rendering Settings" boundaryOpacity setState {item 0 0 item 2 2.5 item 4 2.5 }
"Volume Rendering Settings" moveLowResolutionScale setMinMax 1 10
"Volume Rendering Settings" moveLowResolutionScale setButtons 1
"Volume Rendering Settings" moveLowResolutionScale setEditButton 1
"Volume Rendering Settings" moveLowResolutionScale setIncrement 1
"Volume Rendering Settings" moveLowResolutionScale setValue 3
"Volume Rendering Settings" moveLowResolutionScale setSubMinMax 1 10
"Volume Rendering Settings" samplingQuality setMinMax 0 2
"Volume Rendering Settings" samplingQuality setButtons 0
"Volume Rendering Settings" samplingQuality setEditButton 1
"Volume Rendering Settings" samplingQuality setIncrement 0.133333
"Volume Rendering Settings" samplingQuality setValue 1
"Volume Rendering Settings" samplingQuality setSubMinMax 0 2
"Volume Rendering Settings" optimizations setValue 0 0
"Volume Rendering Settings" optimizations setToggleVisible 0 1
"Volume Rendering Settings" optimizations setValue 1 1
"Volume Rendering Settings" optimizations setToggleVisible 1 1
"Volume Rendering Settings" optimizations setValue 2 0
"Volume Rendering Settings" optimizations setToggleVisible 2 1
"Volume Rendering Settings" sliceAlignment setValue 2
"Volume Rendering Settings" projectionRefinement setMinMax 1 20
"Volume Rendering Settings" projectionRefinement setButtons 1
"Volume Rendering Settings" projectionRefinement setEditButton 1
"Volume Rendering Settings" projectionRefinement setIncrement 1
"Volume Rendering Settings" projectionRefinement setValue 3
"Volume Rendering Settings" projectionRefinement setSubMinMax 1 20
"Volume Rendering Settings" fire
"Volume Rendering Settings" setViewerMask 16383
"Volume Rendering Settings" setShadowStyle 0
"Volume Rendering Settings" setPickable 1

set hideNewModules 0
create HxVolumeRender2 "Volume Rendering"
"Volume Rendering" setIconPosition 365 72
"Volume Rendering" setVar "CustomHelp" {HxVolumeRender2}
"Volume Rendering" data connect "$labelName"
"Volume Rendering" volumeRenderingSettings connect "Volume Rendering Settings"
"Volume Rendering" fire
"Volume Rendering" colormap connect "labels.am"
"Volume Rendering" colormap setDefaultColor 1 1 1
"Volume Rendering" colormap setDefaultAlpha 0.500000
"Volume Rendering" colormap activateLocalRange 1
"Volume Rendering" colormap setLocalMinMax 1.000000 8.000000
"Volume Rendering" colormap enableAlpha 1
"Volume Rendering" colormap enableAlphaToggle 1
"Volume Rendering" colormap setAutoAdjustRangeMode 1
"Volume Rendering" colormap setColorbarMinMax 1 8
"Volume Rendering" fire
"Volume Rendering" colormapLookup setValue 2
"Volume Rendering" gamma setMinMax 0.100000001490116 8
"Volume Rendering" gamma setButtons 0
"Volume Rendering" gamma setEditButton 1
"Volume Rendering" gamma setIncrement 0.526667
"Volume Rendering" gamma setValue 3
"Volume Rendering" gamma setSubMinMax 0.100000001490116 8
"Volume Rendering" alphaScale setMinMax 0 1
"Volume Rendering" alphaScale setButtons 0
"Volume Rendering" alphaScale setEditButton 1
"Volume Rendering" alphaScale setIncrement 0.1
"Volume Rendering" alphaScale setValue 1
"Volume Rendering" alphaScale setSubMinMax 0 1
"Volume Rendering" channelSelector setState {2 }
"Volume Rendering" fire
"Volume Rendering" setViewerMask 16383
"Volume Rendering" setPickable 1
}

#Create a module allowing to apply matlab functions on a stack, connect it to the stack

set hideNewModules 0
create HxCalculus "Calculus MATLAB"
"Calculus MATLAB" setIconPosition 160 10
"Calculus MATLAB" setVar "CustomHelp" {HxCalculus}
"Calculus MATLAB" A connect "$labelName"
"Calculus MATLAB" fire
"Calculus MATLAB" execute setState {item 2 1 }
#Apply the ellipsoid fit through the matlab functions
#The three first lines define the access to the matlab functions in the DevFolder. In case you move the DevFolder, you must modify these lines directly here.
#Make sure the computer you are using has the path to the matlab bin folder added in the Windows environment variable "PATHS".
"Calculus MATLAB" matlabScript setState {

pathToDevFolder = '\\192.168.96.33\data5\Valentin\AVIZO_SEGMENTATION_USABLE_SCRIPTS';

matlabDirectory = strcat(pathToDevFolder,'\DevFolder\Matlab_Local');
addpath(matlabDirectory)

if (exist('field') == 1) && (length(size(field.data))==3)
stackSegmented = permute(field.data,[2,1,3]);
elli = imInertiaEllipsoid(stackSegmented, [0.104104 0.104104 0.100294]);
xc = elli(1);
yc = elli(2);
zc = elli(3);
a = elli(4);
b = elli(5);
c = elli(6);
alpha = deg2rad(elli(9));
beta = deg2rad(elli(8));
gamma = deg2rad(elli(7));
Ralpha = [1 0 0; 0 cos(alpha) -sin(alpha); 0 sin(alpha) cos(alpha)];
Rbeta = [cos(beta) 0 sin(beta); 0 1 0; -sin(beta) 0 cos(beta)];
Rgamma = [cos(gamma) -sin(gamma) 0; sin(gamma) cos(gamma) 0; 0 0 1];
R = Rgamma*Rbeta*Ralpha;
R00 = R(1,1);
R01 = R(1,2);
R02 = R(1,3);
R10 = R(2,1);
R11 = R(2,2);
R12 = R(2,3);
R20 = R(3,1);
R21 = R(3,2);
R22 = R(3,3);
MatlabExportList = {'R00' 'R01' 'R02' 'R10' 'R11' 'R12' 'R20' 'R21' 'R22' 'xc' 'yc' 'zc' 'a' 'b' 'c' 'alpha' 'beta' 'gamma'};
end
}
"Calculus MATLAB" options setValue 0 0
"Calculus MATLAB" options setToggleVisible 0 1
"Calculus MATLAB" options setValue 1 1
"Calculus MATLAB" options setToggleVisible 1 1
"Calculus MATLAB" applyTransformToResult 1
"Calculus MATLAB" fire
"Calculus MATLAB" setViewerMask 16383
"Calculus MATLAB" select
"Calculus MATLAB" setPickable 1

#Try to create result of ellipsoid fit. If an error occurs, it means Avizo can't connect to the matlab engine.
#In that case the information "problem with matlab" is returned and the ellipsoid fit stops.
set hideNewModules 0
if {[catch {[ {Calculus MATLAB} create R00 ] setLabel "R00"}]} {
	return "problem with matlab"
}

if 1 {
#Get in the project view all the resulting parameters of the ellipsoid fit.
# ### coefficients of the rotation matrix ############
"R00" setIconPosition 20 402
"R00" master connect "Calculus MATLAB" "R00" 10
"R00" sharedColormap disconnect
"R00" sharedColormap setDefaultColor 0.8 0.8 0.8
"R00" sharedColormap setDefaultAlpha 0.500000
"R00" sharedColormap activateLocalRange 1
"R00" sharedColormap setLocalMinMax 0.000000 1.000000
"R00" sharedColormap enableAlpha 1
"R00" sharedColormap enableAlphaToggle 1
"R00" sharedColormap setAutoAdjustRangeMode 1
"R00" fire
"R00" fire
"R00" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create R01 ] setLabel "R01"
"R01" setIconPosition 20 402
"R01" master connect "Calculus MATLAB" "R01" 10
"R01" sharedColormap disconnect
"R01" sharedColormap setDefaultColor 0.8 0.8 0.8
"R01" sharedColormap setDefaultAlpha 0.500000
"R01" sharedColormap activateLocalRange 1
"R01" sharedColormap setLocalMinMax 0.000000 1.000000
"R01" sharedColormap enableAlpha 1
"R01" sharedColormap enableAlphaToggle 1
"R01" sharedColormap setAutoAdjustRangeMode 1
"R01" fire
"R01" fire
"R01" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create R02 ] setLabel "R02"
"R02" setIconPosition 20 402
"R02" master connect "Calculus MATLAB" "R02" 10
"R02" sharedColormap disconnect
"R02" sharedColormap setDefaultColor 0.8 0.8 0.8
"R02" sharedColormap setDefaultAlpha 0.500000
"R02" sharedColormap activateLocalRange 1
"R02" sharedColormap setLocalMinMax 0.000000 1.000000
"R02" sharedColormap enableAlpha 1
"R02" sharedColormap enableAlphaToggle 1
"R02" sharedColormap setAutoAdjustRangeMode 1
"R02" fire
"R02" fire
"R02" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create R10 ] setLabel "R10"
"R10" setIconPosition 20 402
"R10" master connect "Calculus MATLAB" "R10" 10
"R10" sharedColormap disconnect
"R10" sharedColormap setDefaultColor 0.8 0.8 0.8
"R10" sharedColormap setDefaultAlpha 0.500000
"R10" sharedColormap activateLocalRange 1
"R10" sharedColormap setLocalMinMax 0.000000 1.000000
"R10" sharedColormap enableAlpha 1
"R10" sharedColormap enableAlphaToggle 1
"R10" sharedColormap setAutoAdjustRangeMode 1
"R10" fire
"R10" fire
"R10" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create R11 ] setLabel "R11"
"R11" setIconPosition 20 402
"R11" master connect "Calculus MATLAB" "R11" 10
"R11" sharedColormap disconnect
"R11" sharedColormap setDefaultColor 0.8 0.8 0.8
"R11" sharedColormap setDefaultAlpha 0.500000
"R11" sharedColormap activateLocalRange 1
"R11" sharedColormap setLocalMinMax 0.000000 1.000000
"R11" sharedColormap enableAlpha 1
"R11" sharedColormap enableAlphaToggle 1
"R11" sharedColormap setAutoAdjustRangeMode 1
"R11" fire
"R11" fire
"R11" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create R12 ] setLabel "R12"
"R12" setIconPosition 20 402
"R12" master connect "Calculus MATLAB" "R12" 10
"R12" sharedColormap disconnect
"R12" sharedColormap setDefaultColor 0.8 0.8 0.8
"R12" sharedColormap setDefaultAlpha 0.500000
"R12" sharedColormap activateLocalRange 1
"R12" sharedColormap setLocalMinMax 0.000000 1.000000
"R12" sharedColormap enableAlpha 1
"R12" sharedColormap enableAlphaToggle 1
"R12" sharedColormap setAutoAdjustRangeMode 1
"R12" fire
"R12" fire
"R12" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create R20 ] setLabel "R20"
"R20" setIconPosition 20 402
"R20" master connect "Calculus MATLAB" "R20" 10
"R20" sharedColormap disconnect
"R20" sharedColormap setDefaultColor 0.8 0.8 0.8
"R20" sharedColormap setDefaultAlpha 0.500000
"R20" sharedColormap activateLocalRange 1
"R20" sharedColormap setLocalMinMax 0.000000 1.000000
"R20" sharedColormap enableAlpha 1
"R20" sharedColormap enableAlphaToggle 1
"R20" sharedColormap setAutoAdjustRangeMode 1
"R20" fire
"R20" fire
"R20" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create R21 ] setLabel "R21"
"R21" setIconPosition 20 402
"R21" master connect "Calculus MATLAB" "R21" 10
"R21" sharedColormap disconnect
"R21" sharedColormap setDefaultColor 0.8 0.8 0.8
"R21" sharedColormap setDefaultAlpha 0.500000
"R21" sharedColormap activateLocalRange 1
"R21" sharedColormap setLocalMinMax 0.000000 1.000000
"R21" sharedColormap enableAlpha 1
"R21" sharedColormap enableAlphaToggle 1
"R21" sharedColormap setAutoAdjustRangeMode 1
"R21" fire
"R21" fire
"R21" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create R22 ] setLabel "R22"
"R22" setIconPosition 20 402
"R22" master connect "Calculus MATLAB" "R22" 10
"R22" sharedColormap disconnect
"R22" sharedColormap setDefaultColor 0.8 0.8 0.8
"R22" sharedColormap setDefaultAlpha 0.500000
"R22" sharedColormap activateLocalRange 1
"R22" sharedColormap setLocalMinMax 0.000000 1.000000
"R22" sharedColormap enableAlpha 1
"R22" sharedColormap enableAlphaToggle 1
"R22" sharedColormap setAutoAdjustRangeMode 1
"R22" fire
"R22" fire
"R22" setViewerMask 16383

# #######################################

# Coordinates of the center of the ellipsoid #
set hideNewModules 0
[ {Calculus MATLAB} create xc ] setLabel "xc"
"xc" setIconPosition 20 402
"xc" master connect "Calculus MATLAB" "xc" 10
"xc" sharedColormap disconnect
"xc" sharedColormap setDefaultColor 0.8 0.8 0.8
"xc" sharedColormap setDefaultAlpha 0.500000
"xc" sharedColormap activateLocalRange 1
"xc" sharedColormap setLocalMinMax 0.000000 1.000000
"xc" sharedColormap enableAlpha 1
"xc" sharedColormap enableAlphaToggle 1
"xc" sharedColormap setAutoAdjustRangeMode 1
"xc" fire
"xc" fire
"xc" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create yc ] setLabel "yc"
"yc" setIconPosition 20 402
"yc" master connect "Calculus MATLAB" "yc" 10
"yc" sharedColormap disconnect
"yc" sharedColormap setDefaultColor 0.8 0.8 0.8
"yc" sharedColormap setDefaultAlpha 0.500000
"yc" sharedColormap activateLocalRange 1
"yc" sharedColormap setLocalMinMax 0.000000 1.000000
"yc" sharedColormap enableAlpha 1
"yc" sharedColormap enableAlphaToggle 1
"yc" sharedColormap setAutoAdjustRangeMode 1
"yc" fire
"yc" fire
"yc" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create zc] setLabel "zc"
"zc" setIconPosition 20 402
"zc" master connect "Calculus MATLAB" "zc" 10
"zc" sharedColormap disconnect
"zc" sharedColormap setDefaultColor 0.8 0.8 0.8
"zc" sharedColormap setDefaultAlpha 0.500000
"zc" sharedColormap activateLocalRange 1
"zc" sharedColormap setLocalMinMax 0.000000 1.000000
"zc" sharedColormap enableAlpha 1
"zc" sharedColormap enableAlphaToggle 1
"zc" sharedColormap setAutoAdjustRangeMode 1
"zc" fire
"zc" fire
"zc" setViewerMask 16383

# ##############################################

# Radiuses of the ellipsoid #

set hideNewModules 0
[ {Calculus MATLAB} create a ] setLabel "a"
"a" setIconPosition 20 402
"a" master connect "Calculus MATLAB" "a" 10
"a" sharedColormap disconnect
"a" sharedColormap setDefaultColor 0.8 0.8 0.8
"a" sharedColormap setDefaultAlpha 0.500000
"a" sharedColormap activateLocalRange 1
"a" sharedColormap setLocalMinMax 0.000000 1.000000
"a" sharedColormap enableAlpha 1
"a" sharedColormap enableAlphaToggle 1
"a" sharedColormap setAutoAdjustRangeMode 1
"a" fire
"a" fire
"a" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create b ] setLabel "b"
"b" setIconPosition 20 402
"b" master connect "Calculus MATLAB" "b" 10
"b" sharedColormap disconnect
"b" sharedColormap setDefaultColor 0.8 0.8 0.8
"b" sharedColormap setDefaultAlpha 0.500000
"b" sharedColormap activateLocalRange 1
"b" sharedColormap setLocalMinMax 0.000000 1.000000
"b" sharedColormap enableAlpha 1
"b" sharedColormap enableAlphaToggle 1
"b" sharedColormap setAutoAdjustRangeMode 1
"b" fire
"b" fire
"b" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create c ] setLabel "c"
"c" setIconPosition 20 402
"c" master connect "Calculus MATLAB" "c" 10
"c" sharedColormap disconnect
"c" sharedColormap setDefaultColor 0.8 0.8 0.8
"c" sharedColormap setDefaultAlpha 0.500000
"c" sharedColormap activateLocalRange 1
"c" sharedColormap setLocalMinMax 0.000000 1.000000
"c" sharedColormap enableAlpha 1
"c" sharedColormap enableAlphaToggle 1
"c" sharedColormap setAutoAdjustRangeMode 1
"c" fire
"c" fire
"c" setViewerMask 16383

# ###############################################"

# Angles of the ellipsoid #

set hideNewModules 0
[ {Calculus MATLAB} create alpha ] setLabel "alpha"
"alpha" setIconPosition 20 402
"alpha" master connect "Calculus MATLAB" "alpha" 10
"alpha" sharedColormap disconnect
"alpha" sharedColormap setDefaultColor 0.8 0.8 0.8
"alpha" sharedColormap setDefaultAlpha 0.500000
"alpha" sharedColormap activateLocalRange 1
"alpha" sharedColormap setLocalMinMax 0.000000 1.000000
"alpha" sharedColormap enableAlpha 1
"alpha" sharedColormap enableAlphaToggle 1
"alpha" sharedColormap setAutoAdjustRangeMode 1
"alpha" fire
"alpha" fire
"alpha" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create beta ] setLabel "beta"
"beta" setIconPosition 20 402
"beta" master connect "Calculus MATLAB" "beta" 10
"beta" sharedColormap disconnect
"beta" sharedColormap setDefaultColor 0.8 0.8 0.8
"beta" sharedColormap setDefaultAlpha 0.500000
"beta" sharedColormap activateLocalRange 1
"beta" sharedColormap setLocalMinMax 0.000000 1.000000
"beta" sharedColormap enableAlpha 1
"beta" sharedColormap enableAlphaToggle 1
"beta" sharedColormap setAutoAdjustRangeMode 1
"beta" fire
"beta" fire
"beta" setViewerMask 16383

set hideNewModules 0
[ {Calculus MATLAB} create gamma ] setLabel "gamma"
"gamma" setIconPosition 20 402
"gamma" master connect "Calculus MATLAB" "gamma" 10
"gamma" sharedColormap disconnect
"gamma" sharedColormap setDefaultColor 0.8 0.8 0.8
"gamma" sharedColormap setDefaultAlpha 0.500000
"gamma" sharedColormap activateLocalRange 1
"gamma" sharedColormap setLocalMinMax 0.000000 1.000000
"gamma" sharedColormap enableAlpha 1
"gamma" sharedColormap enableAlphaToggle 1
"gamma" sharedColormap setAutoAdjustRangeMode 1
"gamma" fire
"gamma" fire
"gamma" setViewerMask 16383

# ################################

#Set the parameters into variables to manipulate them easily

set R00 ["R00" getValue 0 0 0]
set R01 ["R01" getValue 0 0 0]
set R02 ["R02" getValue 0 0 0]
set R10 ["R10" getValue 0 0 0]
set R11 ["R11" getValue 0 0 0]
set R12 ["R12" getValue 0 0 0]
set R20 ["R20" getValue 0 0 0]
set R21 ["R21" getValue 0 0 0]
set R22 ["R22" getValue 0 0 0]
set xc ["xc" getValue 0 0 0]
set yc ["yc" getValue 0 0 0]
set zc ["zc" getValue 0 0 0]
set a ["a" getValue 0 0 0]
set b ["b" getValue 0 0 0]
set c ["c" getValue 0 0 0]
set alpha ["alpha" getValue 0 0 0]
set beta ["beta" getValue 0 0 0]
set gamma ["gamma" getValue 0 0 0]

#Create the ellipsoid as a parametric surface

set hideNewModules 0
create HxParametricSurface "Parametric Surface"
"Parametric Surface" setIconPosition 252 32
"Parametric Surface" setVar "CustomHelp" {HxParametricSurface}
"Parametric Surface" colormap connect "physics.icol"
"Parametric Surface" colormap setDefaultColor 1 0.1 0.1
"Parametric Surface" colormap setDefaultAlpha 0.500000
"Parametric Surface" colormap activateLocalRange 1
"Parametric Surface" colormap setLocalMinMax 0.000000 1.000000
"Parametric Surface" colormap enableAlpha 1
"Parametric Surface" colormap enableAlphaToggle 1
"Parametric Surface" colormap setAutoAdjustRangeMode 1
"Parametric Surface" colormap setColorbarMinMax 0 120
"Parametric Surface" time setMinMax 0 1
"Parametric Surface" time setSubMinMax 0 1
"Parametric Surface" time setValue 1
"Parametric Surface" time setDiscrete 0
"Parametric Surface" time setIncrement 0.01
"Parametric Surface" time animationMode -once
"Parametric Surface" time setAnimationDelay 10
"Parametric Surface" fire
"Parametric Surface" drawStyle setValue 0
"Parametric Surface" fire
"Parametric Surface" drawStyle setSpecularLighting 1
"Parametric Surface" drawStyle setTexture 0
"Parametric Surface" drawStyle setAlphaMode 1
"Parametric Surface" drawStyle setCullingMode 0
"Parametric Surface" drawStyle setNormalBinding 1
"Parametric Surface" drawStyle setSortingMode 1
"Parametric Surface" drawStyle setLineWidth 1.000000
"Parametric Surface" drawStyle setOutlineColor 0 0 0.2
"Parametric Surface" textureWrap setIndex 0 1
"Parametric Surface" preDefinedSurfaces setIndex 0 11
"Parametric Surface" u setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Parametric Surface" u setValue 0 -1.570795059
"Parametric Surface" u setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Parametric Surface" u setValue 1 0.100000001490116
"Parametric Surface" u setMinMax 2 -3.40282346638529e+038 3.40282346638529e+038
"Parametric Surface" u setValue 2 1.570795059
"Parametric Surface" v setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Parametric Surface" v setValue 0 -3.1415901184082
"Parametric Surface" v setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Parametric Surface" v setValue 1 0.100000001490116
"Parametric Surface" v setMinMax 2 -3.40282346638529e+038 3.40282346638529e+038
"Parametric Surface" v setValue 2 3.1415901184082
#Parametric equation of the ellipsoid
"Parametric Surface" x setState "$R00*$a*cos(u)*cos(v) + $R01*$b*cos(u)*sin(v) + $R02*$c*sin(u) + $xc"
"Parametric Surface" y setState "$R10*$a*cos(u)*cos(v) + $R11*$b*cos(u)*sin(v) + $R12*$c*sin(u) + $yc"
"Parametric Surface" z setState "$R20*$a*cos(u)*cos(v) + $R21*$b*cos(u)*sin(v) + $R22*$c*sin(u) + $zc"
#
"Parametric Surface" setLighting 1
"Parametric Surface" fire
"Parametric Surface" setViewerMask 16369
"Parametric Surface" select
"Parametric Surface" setShadowStyle 0
"Parametric Surface" setPickable 1
"Parametric Surface" DoIt snap 0 1
}

#Get an Avizo surface object from the parametric surface
set hideNewModules 0
create HxViewBaseExtract "Extract Surface"
"Extract Surface" setIconPosition 160 156
"Extract Surface" setVar "CustomHelp" {HxViewBaseExtract}
"Extract Surface" setNumInputs 2
"Extract Surface" module1 connect "Parametric Surface"
"Extract Surface" fire
"Extract Surface" options setValue 0 0
"Extract Surface" options setToggleVisible 0 1
"Extract Surface" applyTransformToResult 1
"Extract Surface" fire
"Extract Surface" setViewerMask 16383
"Extract Surface" setPickable 1

set hideNewModules 0
[ "Extract Surface" action hit; "Extract Surface" fire; "Extract Surface" getResult ] setLabel "ExtractedSurface"
"ExtractedSurface" setIconPosition 193 222
"ExtractedSurface" master connect "Extract Surface" "result" 0
"ExtractedSurface" fire
"ExtractedSurface" LevelOfDetail setMinMax -1 -1
"ExtractedSurface" LevelOfDetail setButtons 1
"ExtractedSurface" LevelOfDetail setEditButton 1
"ExtractedSurface" LevelOfDetail setIncrement 1
"ExtractedSurface" LevelOfDetail setValue -1
"ExtractedSurface" LevelOfDetail setSubMinMax -1 -1
"ExtractedSurface" fire
"ExtractedSurface" setViewerMask 16383

#Convert the surface to a normal binary image stack
#Get the dimensions of the processed stack represented by labelName in the Avizo project view
set dims ["$labelName" getDims]
#Set the physical size of the stack to be extracted from the surface object
set phyX [expr [lindex $dims 0]*$voxelSizeX]
set phyY [expr [lindex $dims 1]*$voxelSizeY]
set phyZ [expr [lindex $dims 2]*$voxelSizeZ]
echo phyX$phyX
echo phyY$phyY
echo phyZ$phyZ
#Create a module to transform a surface object into a stack
set hideNewModules 0
create HxScanConvertSurface "Scan Surface To Volume"
"Scan Surface To Volume" setIconPosition 347 169
"Scan Surface To Volume" setVar "CustomHelp" {HxScanConvertSurface}
"Scan Surface To Volume" data connect "ExtractedSurface"
"Scan Surface To Volume" field connect "$labelName"
"Scan Surface To Volume" fire
"Scan Surface To Volume" bbox setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
"Scan Surface To Volume" bbox setValue 0 0
"Scan Surface To Volume" bbox setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
"Scan Surface To Volume" bbox setValue 1 $phyX
"Scan Surface To Volume" bbox setMinMax 2 -3.40282346638529e+038 3.40282346638529e+038
"Scan Surface To Volume" bbox setValue 2 0
"Scan Surface To Volume" bbox setMinMax 3 -3.40282346638529e+038 3.40282346638529e+038
"Scan Surface To Volume" bbox setValue 3 $phyY
"Scan Surface To Volume" bbox setMinMax 4 -3.40282346638529e+038 3.40282346638529e+038
"Scan Surface To Volume" bbox setValue 4 0
"Scan Surface To Volume" bbox setMinMax 5 -3.40282346638529e+038 3.40282346638529e+038
"Scan Surface To Volume" bbox setValue 5 $phyZ
"Scan Surface To Volume" dimensions setMinMax 0 -16777216 16777216
"Scan Surface To Volume" dimensions setValue 0 [lindex $dims 0]
"Scan Surface To Volume" dimensions setMinMax 1 -16777216 16777216
"Scan Surface To Volume" dimensions setValue 1 [lindex $dims 1]
"Scan Surface To Volume" dimensions setMinMax 2 -16777216 16777216
"Scan Surface To Volume" dimensions setValue 2 [lindex $dims 2]
"Scan Surface To Volume" materials setIndex 0 0
"Scan Surface To Volume" options setValue 0 0
"Scan Surface To Volume" options setToggleVisible 0 1
"Scan Surface To Volume" applyTransformToResult 1
"Scan Surface To Volume" fire
"Scan Surface To Volume" setViewerMask 16383
"Scan Surface To Volume" setPickable 1

set hideNewModules 0
[ {Scan Surface To Volume} create result ] setLabel "ExtractedSurface.scanConverted"
"ExtractedSurface.scanConverted" setIconPosition 219 294
"ExtractedSurface.scanConverted" master connect "Scan Surface To Volume" "result" 0
"ExtractedSurface.scanConverted" sharedColormap connect "labels.am"
"ExtractedSurface.scanConverted" sharedColormap setDefaultColor 0.8 0.8 0.8
"ExtractedSurface.scanConverted" sharedColormap setDefaultAlpha 0.500000
"ExtractedSurface.scanConverted" sharedColormap activateLocalRange 1
"ExtractedSurface.scanConverted" sharedColormap setLocalMinMax 1.000000 8.000000
"ExtractedSurface.scanConverted" sharedColormap enableAlpha 1
"ExtractedSurface.scanConverted" sharedColormap enableAlphaToggle 1
"ExtractedSurface.scanConverted" sharedColormap setAutoAdjustRangeMode 1
"ExtractedSurface.scanConverted" sharedColormap setColorbarMinMax 1 8
"ExtractedSurface.scanConverted" fire
"ExtractedSurface.scanConverted" primary setIndex 0 0
"ExtractedSurface.scanConverted" fire
"ExtractedSurface.scanConverted" setViewerMask 16383

#Extract parameters of the ellipsoid in a table
set hideNewModules 0
create HxAnalyzeLabels "Label Analysis Ellipsoid"
"Label Analysis Ellipsoid" setIconPosition 175 330
"Label Analysis Ellipsoid" setVar "CustomHelp" {HxAnalyzeLabels}
"Label Analysis Ellipsoid" data connect "ExtractedSurface.scanConverted"
"Label Analysis Ellipsoid" fire
"Label Analysis Ellipsoid" interpretation setValue 0
"Label Analysis Ellipsoid" sequenceMode setValue 0
labelMeasure setAttributes feret2d 0 18 36 54 72 90 108 126 144 162
labelMeasure setAttributes feret3d 31
labelMeasure setAttributes cooccurrence 0 0
labelMeasure setAttributes histogram 1 0 255 1
labelMeasure setAttributes quantile 0.1 0.1 0.1 0.1 0.1 0.1
labelMeasure setAttributes breadth3d 10
"Label Analysis Ellipsoid" measures setState {"ellipsoidVolAndSphericity" Volume3d Shape_VA3d}
"Label Analysis Ellipsoid" showAnalysis setValue 0 1
"Label Analysis Ellipsoid" showAnalysis setToggleVisible 0 1
"Label Analysis Ellipsoid" applyTransformToResult 1
"Label Analysis Ellipsoid" fire
"Label Analysis Ellipsoid" setViewerMask 16383
"Label Analysis Ellipsoid" setPickable 1

#Creation of the table
set hideNewModules 0
[ {Label Analysis Ellipsoid} create AnlOut ] setLabel "ExtractedSurface.Label-Analysis"
"ExtractedSurface.Label-Analysis" setIconPosition 215 377
"ExtractedSurface.Label-Analysis" master connect "Label Analysis Ellipsoid" "AnlOut" 0
"ExtractedSurface.Label-Analysis" fire
"ExtractedSurface.Label-Analysis" fire
"ExtractedSurface.Label-Analysis" setViewerMask 16383

#Creation of the stack associated with the table
set hideNewModules 0
[ {Label Analysis Ellipsoid} create ImgOutLab ] setLabel "ExtractedSurface.label"
"ExtractedSurface.label" setIconPosition 35 366
"ExtractedSurface.label" master connect "Label Analysis Ellipsoid" "ImgOutLab" 1
"ExtractedSurface.label" sharedColormap connect "labels.am"
"ExtractedSurface.label" sharedColormap setDefaultColor 0.8 0.8 0.8
"ExtractedSurface.label" sharedColormap setDefaultAlpha 0.500000
"ExtractedSurface.label" sharedColormap activateLocalRange 1
"ExtractedSurface.label" sharedColormap setLocalMinMax 1.000000 8.000000
"ExtractedSurface.label" sharedColormap enableAlpha 1
"ExtractedSurface.label" sharedColormap enableAlphaToggle 1
"ExtractedSurface.label" sharedColormap setAutoAdjustRangeMode 1
"ExtractedSurface.label" sharedColormap setColorbarMinMax 1 8
"ExtractedSurface.label" fire
"ExtractedSurface.label" primary setIndex 0 0
"ExtractedSurface.label" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
"ExtractedSurface.label" fire
"ExtractedSurface.label" setViewerMask 16383


#Extract from the table sphericity and volume of the ellipsoid

set ellipsoidSphericity ["ExtractedSurface.Label-Analysis" getValue 1 0]
set ellipsoidVolume ["ExtractedSurface.Label-Analysis" getValue 0 0]
echo $ellipsoidVolume

#Set path to ellisoid fit files directory
set ellipsoidFitDirectory [file join $cellFolderOutputPath ellipsoidFitFiles]
#Create the directory (maybe unecessary)
file mkdir $ellipsoidFitDirectory
#Save the project file
saveProjectFiles $ellipsoidFitDirectory [lindex [split $labelName "."] 0]\_ellipsoidFit
#Save the stack created from the ellipsoid
saveDataToFile [file join $ellipsoidFitDirectory ellipsoidStack_$labelName\.tif] "3D Tiff" "ExtractedSurface.scanConverted"

#Return parameters of the ellipsoid
return [list $a $b $c $xc $yc $zc $alpha $beta $gamma $ellipsoidSphericity $ellipsoidVolume]
}

#Function checking if the reference images are accessible (report p 43)
#customReferenceImageMembrane : path to the membrane reference stack. Ex : "D:/Valentin/S2_w1VTI-561_cmle.tif"
#customReferenceImageScaffold : path to the scaffold reference stack. Ex : "D:/Valentin/B4_w1VTI-561_cmle.tif"
proc referenceImagesSetup {pathToDevFolder customReferenceImageMembrane customReferenceImageScaffold} {
	#Check if membrane reference stack exists
	if {![isDirectoryOrFileExist "$pathToDevFolder\/DevFolder/S2_w1VTI-561_cmle.tif"]} {
		error "Can't find the default membrane reference image. Make sure 'S2_w1VTI-561_cmle.tif' is in the DevFolder"
	}
	#check if scaffold reference stack exists
	if {![isDirectoryOrFileExist "$pathToDevFolder\/DevFolder/B4_w1VTI-561_cmle.tif"]} {
		error "Can't find the default scaffold reference image. Make sure 'B4_w1VTI-561_cmle.tif' is in the DevFolder"
	}
	
	#Set path of the default reference stack for membrane
	set refImageMembrane "$pathToDevFolder\/DevFolder/S2_w1VTI-561_cmle.tif"
	#If user entered a custom stack, set the path to the custom stack instead
	if {$customReferenceImageMembrane != ""} {
		set refImageMembrane $customReferenceImageMembrane
	}

	#Set path of the default reference stack for scaffold
	set refImageScaffold "$pathToDevFolder\/DevFolder/B4_w1VTI-561_cmle.tif"
	#If user entered a custom stack, set the path to the custom stack instead
	if {$customReferenceImageScaffold != ""} {
		set refImageScaffold $customReferenceImageScaffold
	}
	
	#Return the paths to reference images
	return [list $refImageMembrane $refImageScaffold]
}

#Function calling the GUI and extracting parameters from input text file (report p 38-39-43)
proc execGUI {executableGUIPath inputParametersFilePath} {
	#Calls the GUI as an external program.
	exec $executableGUIPath
	
	#Check if input text file is accessible.
	if {![isDirectoryOrFileExist $inputParametersFilePath]} {
		error "Can't access $inputParametersFilePath. \ 
		\n Please make sure your paths to the input parameters file are the same in your TCL and GUI code"
	}
	
	#Extract input parameters from text file
	set inputParametersFromGUI [readFile $inputParametersFilePath "\n"]
	#Remove the text file
	file delete $inputParametersFilePath
	echo $inputParametersFromGUI
	#Return the input parameters
	return $inputParametersFromGUI
}

# ####################################


# ##### Minor Functions #############

#Function exporting a stack opened in Avizo in a file Path
#Ex : filePath = "D:/Valentin/myStack.tif
#fileFormat = 3D Tiff
#labelName = image.processed
proc saveDataToFile {filePath fileFormat labelName} {
	#Remove the file if it already exists
	if {[isDirectoryOrFileExist $filePath]} {
		echo [isDirectoryOrFileExist $filePath]
		echo $filePath
		file delete $filePath
	}
	#Export stack as a file 
	"$labelName" exportData $fileFormat $filePath
}

#Function saving a ".hx" in a diirectory
#Ex : directory = "D:/Valentin/outputs/hxFiles
#projectName = myProject
proc saveProjectFiles {directory projectName} {
	if {[isDirectoryOrFileExist [file join $directory $projectName\-files]]} {
		file delete -force [file join $directory $projectName\-files]
	}
	if {[isDirectoryOrFileExist [file join $directory $projectName\.hx]]} {
		file delete [file join $directory $projectName\.hx]
	}
	theProperties show
	saveProjectAs -forceAutoSave -packAndGo [file join $directory $projectName\.hx]
	theProperties hide
}

#Function checking if a particular file or directory exists.
#Ex : directoryOrFile = "D:/Valentin" or "D:/Valentin/file.tif"
#Return 0 or 1
proc isDirectoryOrFileExist {directoryOrFile} {
	return [file exists $directoryOrFile]
}

#Function checking if a directory is empty
#Ex : directory = "D:/Valentin"
#Return 0 or 1
proc isDirectoryEmpty {directory} {
	if {[glob -nocomplain -dir $directory *] != ""} {
		return 0
	} else {
		return 1
	}
}

#Function returning all the files and folders contained in a directory as a list.
#Ex : directory = "D:/Valentin"
#flag can be equal to "path" or "tail"
#"path" -> return the full path of each folder and file -> Ex : "D:/Valentin/folderInValentin" or "D:/Valentin/fileInValentin.txt"
#"tail" -> return only the tail -> Ex : "folderInValentin" or "fileInValentin.txt"
#If directory is empty, return an empty string
proc getDirectoryContent {directory flag} {
	if {$flag == "path"} {
		#-nocomplain prevents errors if directory is empty
		return [glob -nocomplain -dir $directory *]
	} elseif {$flag == "tail"} {
		return [glob -nocomplain -tails -dir $directory *]
	}
}

#Function returning all the files contained in a directory with a particular extension as a list.
#Ex : directory = "D:/Valentin", extension = ".tif"
#flag can be equal to "path" or "tail"
#"path" -> return the full path of each file -> Ex : "D:/Valentin/fileInValentin.tif"
#"tail" -> return only the tail -> Ex : "fileInValentin.tif"
#If directory is empty, return an empty string
proc getFilesInDirectory {directory extension flag} {
	if {$flag == "path"} {
	#-nocomplain prevents errors if directory is empty
		return [glob -nocomplain -dir $directory *$extension]
	} elseif {$flag == "tail"} {
		return [glob -nocomplain -tails -dir $directory *$extension]
	}	
}

#Function extracting the content of a file in a list
#Ex : filePath = "D:/Valentin/fileInValentin.txt", separator = "\n" (newline character), or "," (for CSV files), or ...
proc readFile {filePath separator} {
	#open a read channel towards the file
	set fileReadChannel [open $filePath r]
	#Extract the content
	#-nonewline remove the newline character at the end of the file
	set fileContent [read -nonewline $fileReadChannel]
	#close the channel
	close $fileReadChannel
	#Split the content based on separator to make a list
	set fileContentSplitted [split $fileContent $separator]
	#return the list
	return $fileContentSplitted
}

#Function writing a content in a file"
#Ex : filePath = "D:/Valentin/fileInValentin.txt", content = "hello my name is Valentin"
#flag can be equal to "append" or "overwrite"
#"append" -> write on a newline in the file, without removing the current content
#"overwrite" -> overwrite the current content of the file and restart writing from the first line
#If the file given by filePath doesn't exist, it is automatically created
proc writeFile {filePath content flag} {
	if {$flag == "append"} {
		#Open a write channel towards the file with the append option (a)
		set fileWriteChannel [open $filePath a]
	} elseif {$flag == "overwrite"} {
		#Open a write channel towards the file with the overwrite option (w)
		set fileWriteChannel [open $filePath w]
	}
	#Write in the file
	puts $fileWriteChannel $content
	#Close the channel
	close $fileWriteChannel
}

#Function writing a content in a CSV file
#Ex : filePath = "D:/Valentin/fileInValentin.csv", content = "1 2 3 4 5", separator = ","
#flag can be equal to "append" or "overwrite"
#"append" -> write on a row in the file, without removing the current content
#"overwrite" -> overwrite the current content of the file and restart writing from the first row
#If the file given by filePath doesn't exist, it is automatically created
proc writeCSVFile {filePath content separator flag} {
	if {$flag == "append"} {
		#Open a write channel towards the file with the append option (a)
		set CSVfileWriteChannel [open $filePath a]
	} elseif {$flag == "overwrite"} {
		#Open a write channel towards the file with the overwrite option (w)
		set CSVfileWriteChannel [open $filePath w]
	}
	#Join the content of the list "content" with the separator (Ex : "1 2 3 4 5" -> "1,2,3,4,5") and write it in the first row of the CSV file
	puts $CSVfileWriteChannel [join $content $separator]
	#close the channel
	close $CSVfileWriteChannel
}

#Function returning the elements of a list "elementList" having "expression" in their expression
#Ex : elementList = "Hello41 Goodbye65", expression = 41 -> return Hello41
proc getElementRegexp {elementList expression} {
	return [lsearch -regexp -inline $elementList $expression]
}

#Function resampling a stack opened in Avizo, using the given voxel sizes 
#labelName is the name of the label representing the stack in the Avizo project view.
proc resample {labelName voxelSizeX voxelSizeY voxelSizeZ} {
	set dims ["$labelName" getDims]
	"$labelName" setBoundingBox 0 [expr [lindex $dims 0]*$voxelSizeX] 0 [expr [lindex $dims 1]*$voxelSizeY] 0 [expr [lindex $dims 2]*$voxelSizeZ] 
}

#Function used to load a stack processed by ImageJ in Avizo and compare them to the current stack
proc getTBSegmentation {imageStackName imageStackBoundary segmentedFolderPath extension voxelSizeX voxelSizeY voxelSizeZ} {
	set hideNewModules 0
	[load -tif +mode 100 +box 0 1 0 1 0 1 [file join $segmentedFolderPath segmented $imageStackName\SEG$extension]] setLabel "$imageStackName.SEG"

	resample "$imageStackName.SEG" $voxelSizeX $voxelSizeY $voxelSizeZ

	set hideNewModules 0
	create auto_threshold "Auto Thresholding TB"
	"Auto Thresholding TB" setIconPosition 39 616
	"Auto Thresholding TB" setVar "CustomHelp" {auto_threshold}
	"Auto Thresholding TB" Type setState {type Auto Threshold High}
	"Auto Thresholding TB" interpretation setValue 0
	"Auto Thresholding TB" outputLocation setIndex 0 0
	"Auto Thresholding TB" inputImage connect "$imageStackName.SEG"
	"Auto Thresholding TB" fire
	"Auto Thresholding TB" mode setIndex 0 0
	"Auto Thresholding TB" fire
	"Auto Thresholding TB" inputRange setMinMax 0 -2147483648 2147483648
	"Auto Thresholding TB" inputRange setValue 0 0
	"Auto Thresholding TB" inputRange setMinMax 1 -2147483648 2147483648
	"Auto Thresholding TB" inputRange setValue 1 255
	"Auto Thresholding TB" fire
	"Auto Thresholding TB" criterion setIndex 0 1
	"Auto Thresholding TB" fire
	"Auto Thresholding TB" applyTransformToResult 1
	"Auto Thresholding TB" fire
	"Auto Thresholding TB" setViewerMask 16383
	"Auto Thresholding TB" setPickable 1

	set hideNewModules 0
	[ {Auto Thresholding TB} create ImgOutBin ] setLabel "$imageStackName.SEG.labels"
	"$imageStackName.SEG.labels" setIconPosition 20 652
	"$imageStackName.SEG.labels" master connect "Auto Thresholding TB" "ImgOutBin" 0
	"$imageStackName.SEG.labels" sharedColormap connect "labels.am"
	"$imageStackName.SEG.labels" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$imageStackName.SEG.labels" sharedColormap setDefaultAlpha 0.500000
	"$imageStackName.SEG.labels" sharedColormap activateLocalRange 1
	"$imageStackName.SEG.labels" sharedColormap setLocalMinMax 1.000000 8.000000
	"$imageStackName.SEG.labels" sharedColormap enableAlpha 1
	"$imageStackName.SEG.labels" sharedColormap enableAlphaToggle 1
	"$imageStackName.SEG.labels" sharedColormap setAutoAdjustRangeMode 1
	"$imageStackName.SEG.labels" sharedColormap setColorbarMinMax 1 8
	"$imageStackName.SEG.labels" fire
	"$imageStackName.SEG.labels" primary setIndex 0 0
	"$imageStackName.SEG.labels" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$imageStackName.SEG.labels" fire
	"$imageStackName.SEG.labels" setViewerMask 16383

	set hideNewModules 0
	[ {Auto Thresholding TB} create MOutMsrSheet ] setLabel "$imageStackName.SEG.info"
	"$imageStackName.SEG.info" setIconPosition 20 688
	"$imageStackName.SEG.info" master connect "Auto Thresholding TB" "MOutMsrSheet" 1
	"$imageStackName.SEG.info" fire
	"$imageStackName.SEG.info" fire
	"$imageStackName.SEG.info" setViewerMask 16383

	set hideNewModules 0
	create boundary "Label Boundaries 2"
	"Label Boundaries 2" setIconPosition 149 732
	"Label Boundaries 2" setVar "CustomHelp" {boundary.html}
	"Label Boundaries 2" interpretation setValue 0
	"Label Boundaries 2" outputLocation setIndex 0 0
	"Label Boundaries 2" inputImage connect "$imageStackName.SEG.labels"
	"Label Boundaries 2" applyTransformToResult 1
	"Label Boundaries 2" fire
	"Label Boundaries 2" setViewerMask 16383
	"Label Boundaries 2" setPickable 1

	set hideNewModules 0
	[ {Label Boundaries 2} create ImgOut ] setLabel "$imageStackName.SEG.boundary"
	"$imageStackName.SEG.boundary" setIconPosition 20 780
	"$imageStackName.SEG.boundary" master connect "Label Boundaries 2" "ImgOut" 0
	"$imageStackName.SEG.boundary" sharedColormap connect "labels.am"
	"$imageStackName.SEG.boundary" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$imageStackName.SEG.boundary" sharedColormap setDefaultAlpha 0.500000
	"$imageStackName.SEG.boundary" sharedColormap activateLocalRange 1
	"$imageStackName.SEG.boundary" sharedColormap setLocalMinMax 1.000000 8.000000
	"$imageStackName.SEG.boundary" sharedColormap enableAlpha 1
	"$imageStackName.SEG.boundary" sharedColormap enableAlphaToggle 1
	"$imageStackName.SEG.boundary" sharedColormap setAutoAdjustRangeMode 1
	"$imageStackName.SEG.boundary" sharedColormap setColorbarMinMax 1 8
	"$imageStackName.SEG.boundary" fire
	"$imageStackName.SEG.boundary" primary setIndex 0 0
	"$imageStackName.SEG.boundary" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$imageStackName.SEG.boundary" fire
	"$imageStackName.SEG.boundary" setViewerMask 16383

	set hideNewModules 0
	create logical_orimage "OR Image"
	"OR Image" setIconPosition 83 865
	"OR Image" setVar "CustomHelp" {logical_orimage.html}
	"OR Image" interpretation setValue 0
	"OR Image" outputLocation setIndex 0 0
	"OR Image" inputImage1 connect "$imageStackBoundary"
	"OR Image" inputImage2 connect "$imageStackName.SEG.boundary"
	"OR Image" applyTransformToResult 1
	"OR Image" fire
	"OR Image" setViewerMask 16383
	"OR Image" setPickable 1
	"OR Image" doIt snap 0 1

	set hideNewModules 0
	[ {OR Image} create ImgOut ] setLabel "Result2.or"
	"Result2.or" setIconPosition 20 901
	"Result2.or" master connect "OR Image" "ImgOut" 0
	"Result2.or" sharedColormap connect "labels.am"
	"Result2.or" sharedColormap setDefaultColor 0.8 0.8 0.8
	"Result2.or" sharedColormap setDefaultAlpha 0.500000
	"Result2.or" sharedColormap activateLocalRange 1
	"Result2.or" sharedColormap setLocalMinMax 1.000000 8.000000
	"Result2.or" sharedColormap enableAlpha 1
	"Result2.or" sharedColormap enableAlphaToggle 1
	"Result2.or" sharedColormap setAutoAdjustRangeMode 1
	"Result2.or" sharedColormap setColorbarMinMax 1 8
	"Result2.or" fire
	"Result2.or" primary setIndex 0 0
	"Result2.or" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"Result2.or" fire
	"Result2.or" setViewerMask 16383

	set hideNewModules 0
	create HxOrthoSlice "Ortho Slice"
	"Ortho Slice" setIconPosition 681 912
	"Ortho Slice" setVar "CustomHelp" {HxOrthoSlice}
	"Ortho Slice" data connect "$imageStackName"
	"Ortho Slice" fire
	"Ortho Slice" sliceOrientation setValue 0
	"Ortho Slice" fire
	"Ortho Slice" origin  setBoundingBox -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038
	"Ortho Slice" origin  setImmediateMode 0
	"Ortho Slice" origin  setOrtho 0
	"Ortho Slice" origin  showDragger 0
	"Ortho Slice" origin  showPoints 0
	"Ortho Slice" origin  setPointScale 1
	"Ortho Slice" origin  showOptionButton 58
	"Ortho Slice" origin  setNumPoints 1 1 1
	"Ortho Slice" origin  setCoord 0 52.208 52.104 28.2564
	"Ortho Slice" normal  setBoundingBox -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038 -3.40282e+038 3.40282e+038
	"Ortho Slice" normal  setImmediateMode 0
	"Ortho Slice" normal  setOrtho 0
	"Ortho Slice" normal  showDragger 0
	"Ortho Slice" normal  showPoints 0
	"Ortho Slice" normal  setPointScale 1
	"Ortho Slice" normal  showOptionButton 114
	"Ortho Slice" normal  setNumPoints 1 1 1
	"Ortho Slice" normal  setCoord 0 0 0 1
	"Ortho Slice" options setValue 0 1
	"Ortho Slice" options setToggleVisible 0 1
	"Ortho Slice" options setValue 1 0
	"Ortho Slice" options setToggleVisible 1 1
	"Ortho Slice" options setValue 2 0
	"Ortho Slice" options setToggleVisible 2 1
	"Ortho Slice" mappingType setIndex 0 0
	"Ortho Slice" contrastLimit setMinMax 0 -16777216 16777216
	"Ortho Slice" contrastLimit setValue 0 7
	"Ortho Slice" colormap connect "grayScale.am"
	"Ortho Slice" colormap setDefaultColor 1 0.8 0.5
	"Ortho Slice" colormap setDefaultAlpha 1.000000
	"Ortho Slice" colormap activateLocalRange 1
	"Ortho Slice" colormap setLocalMinMax 0.000000 1795.000000
	"Ortho Slice" colormap enableAlpha 1
	"Ortho Slice" colormap enableAlphaToggle 1
	"Ortho Slice" colormap setAutoAdjustRangeMode 1
	"Ortho Slice" colormap setColorbarMinMax 0 65534
	"Ortho Slice" sliceNumber setMinMax 0 500
	"Ortho Slice" sliceNumber setButtons 1
	"Ortho Slice" sliceNumber setEditButton 1
	"Ortho Slice" sliceNumber setIncrement 1
	"Ortho Slice" sliceNumber setValue 282
	"Ortho Slice" sliceNumber setSubMinMax 0 500
	"Ortho Slice" transparency setValue 0
	"Ortho Slice" alpha setMinMax 0 -16777216 16777216
	"Ortho Slice" alpha setValue 0 0
	"Ortho Slice" alpha setMinMax 1 -16777216 16777216
	"Ortho Slice" alpha setValue 1 255
	"Ortho Slice" frameSettings setState {item 0 1 item 2 1 color 3 1 0.5 0 }
	"Ortho Slice" embossingOnOff setValue 0
	"Ortho Slice" depth setMinMax -60 60
	"Ortho Slice" depth setButtons 0
	"Ortho Slice" depth setEditButton 1
	"Ortho Slice" depth setIncrement 8
	"Ortho Slice" depth setValue 2
	"Ortho Slice" depth setSubMinMax -60 60
	"Ortho Slice" fire

	"Ortho Slice" fire
	"Ortho Slice" setViewerMask 16383
	"Ortho Slice" setShadowStyle 0
	"Ortho Slice" setPickable 1

	set hideNewModules 0
	create HxColorwash "Color Wash"
	"Color Wash" setIconPosition 681 938
	"Color Wash" setVar "CustomHelp" {HxColorwash}
	"Color Wash" data connect "Result2.or"
	"Color Wash" module connect "Ortho Slice"
	"Color Wash" colormap connect "labels.am"
	"Color Wash" colormap setDefaultColor 1 0.8 0.5
	"Color Wash" colormap setDefaultAlpha 0.500000
	"Color Wash" colormap activateLocalRange 1
	"Color Wash" colormap setLocalMinMax 1.000000 8.000000
	"Color Wash" colormap enableAlpha 1
	"Color Wash" colormap enableAlphaToggle 1
	"Color Wash" colormap setAutoAdjustRangeMode 1
	"Color Wash" colormap setColorbarMinMax 1 8
	"Color Wash" fire
	"Color Wash" mode setIndex 0 7
	"Color Wash" weightFactor setMinMax 0 1
	"Color Wash" weightFactor setButtons 0
	"Color Wash" weightFactor setEditButton 1
	"Color Wash" weightFactor setIncrement 0.1
	"Color Wash" weightFactor setValue 0.5
	"Color Wash" weightFactor setSubMinMax 0 1
	"Color Wash" lenseWidth setMinMax 5 80
	"Color Wash" lenseWidth setButtons 1
	"Color Wash" lenseWidth setEditButton 1
	"Color Wash" lenseWidth setIncrement 1
	"Color Wash" lenseWidth setValue 30
	"Color Wash" lenseWidth setSubMinMax 5 80
	"Color Wash" overlayRange setMinMax 0 -3.40282346638529e+038 3.40282346638529e+038
	"Color Wash" overlayRange setValue 0 100
	"Color Wash" overlayRange setMinMax 1 -3.40282346638529e+038 3.40282346638529e+038
	"Color Wash" overlayRange setValue 1 1000
	"Color Wash" transparency setMinMax 0 1
	"Color Wash" transparency setButtons 0
	"Color Wash" transparency setEditButton 1
	"Color Wash" transparency setIncrement 0.1
	"Color Wash" transparency setValue 0.3
	"Color Wash" transparency setSubMinMax 0 1
	"Color Wash" options setValue 0 0
	"Color Wash" options setToggleVisible 0 1
	"Color Wash" options setValue 1 1
	"Color Wash" options setToggleVisible 1 1
	"Color Wash" generalOptions setValue 0 0
	"Color Wash" generalOptions setToggleVisible 0 1
	"Color Wash" fire
	"Color Wash" setViewerMask 16383
	"Color Wash" setPickable 1

	set hideNewModules 0
	create HxAnalyzeLabels "Label Analysis 2"
	"Label Analysis 2" setIconPosition 56 508
	"Label Analysis 2" setVar "CustomHelp" {HxAnalyzeLabels}
	"Label Analysis 2" data connect "$imageStackName.SEG.labels"
	"Label Analysis 2" fire
	"Label Analysis 2" interpretation setValue 0
	"Label Analysis 2" sequenceMode setValue 0
	labelMeasure setAttributes feret2d 0 18 36 54 72 90 108 126 144 162
	labelMeasure setAttributes feret3d 31
	labelMeasure setAttributes cooccurrence 0 0
	labelMeasure setAttributes histogram 1 0 255 1
	labelMeasure setAttributes quantile 0.1 0.1 0.1 0.1 0.1 0.1
	labelMeasure setAttributes breadth3d 10
	"Label Analysis 2" measures setState {"basic" Volume3d Area3d BaryCenterX BaryCenterY BaryCenterZ Mean}
	"Label Analysis 2" showAnalysis setValue 0 1
	"Label Analysis 2" showAnalysis setToggleVisible 0 1
	"Label Analysis 2" applyTransformToResult 1
	"Label Analysis 2" fire
	"Label Analysis 2" setViewerMask 16383
	"Label Analysis 2" setPickable 1

	set hideNewModules 0
	[ {Label Analysis 2} create AnlOut ] setLabel "$imageStackName.SEG.Label-Analysis-2"
	"$imageStackName.SEG.Label-Analysis-2" setIconPosition 20 975
	"$imageStackName.SEG.Label-Analysis-2" master connect "Label Analysis 2" "AnlOut" 0
	"$imageStackName.SEG.Label-Analysis-2" fire
	"$imageStackName.SEG.Label-Analysis-2" fire
	"$imageStackName.SEG.Label-Analysis-2" setViewerMask 16383

	set hideNewModules 0
	[ {Label Analysis 2} create ImgOutLab ] setLabel "$imageStackName.SEG.label"
	"$imageStackName.SEG.label" setIconPosition 46 470
	"$imageStackName.SEG.label" master connect "Label Analysis 2" "ImgOutLab" 1
	"$imageStackName.SEG.label" sharedColormap connect "labels.am"
	"$imageStackName.SEG.label" sharedColormap setDefaultColor 0.8 0.8 0.8
	"$imageStackName.SEG.label" sharedColormap setDefaultAlpha 0.500000
	"$imageStackName.SEG.label" sharedColormap activateLocalRange 1
	"$imageStackName.SEG.label" sharedColormap setLocalMinMax 1.000000 8.000000
	"$imageStackName.SEG.label" sharedColormap enableAlpha 1
	"$imageStackName.SEG.label" sharedColormap enableAlphaToggle 1
	"$imageStackName.SEG.label" sharedColormap setAutoAdjustRangeMode 1
	"$imageStackName.SEG.label" sharedColormap setColorbarMinMax 1 8
	"$imageStackName.SEG.label" fire
	"$imageStackName.SEG.label" primary setIndex 0 0
	"$imageStackName.SEG.label" setTransform 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
	"$imageStackName.SEG.label" fire
	"$imageStackName.SEG.label" setViewerMask 16383
}


# #BEGINNING OF THE MACRO # #
# ##### NOTE : THE GUI DOES NOT ALLOW CHOOSING ALL THE POSSIBLE INPUT PARAMETERS. SINCE THE GUI MAY BE REPLACED BY A PYTHON GUI (SEE WITH GIOVANNI), I DID NOT MODIFY THE GUI TO DO SO. ##############
# ##### NOTE 2 : A PROBLEM WITH Qt PREVENT COMPILING A NEW GUI
# PARAMETERS LIKE THE GRAYSCALE NORMALIZATION THRESHOLDS MUST BE MODIFIED DIRECTLY IN THE CODE #






#Hide the properties and help window in Avizo.
theProperties hide
help hide

#Path to the directory containing the "DevFolder", see my report p-40 to get more information about the "DevFolder".
set pathToDevFolder "//192.168.96.33/data5/Valentin/AVIZO_SEGMENTATION_USABLE_SCRIPTS"
#Name of the input parameters file in the DevFolder. Must be the same name used in the GUI code.
set inputParametersFile "inputParameters.txt"
#In the DevFolder, path to the GUI executable file.
set GUI_releaseVersionPath "build-QtFinalGUI-Desktop_Qt_5_11_1_MSVC2017_64bit-Release/release/QtFinalGUI.exe"

#Check if DevFolder exists in the pathToDevFolder, throws an error and notifies the user if it is not the case.
if {![isDirectoryOrFileExist "$pathToDevFolder\/DevFolder"]} {
	error "the DevFolder can't be found in $pathToDevFolder. \n Please add the DevFolder in $pathToDevFolder and restart the program"
	#Quit Avizo when the user closes the pop-up error window.
	quit
}

#Check if the GUI executable file is accessible
if {![isDirectoryOrFileExist "$pathToDevFolder\/DevFolder/$GUI_releaseVersionPath"]} {
	error "The GUI can't be found. Make sure a release version of the GUI is in DevFolder. \n Refers to the user guide to know how to get the required release version"
	#Quit Avizo when the user closes the pop-up error window.
	quit
}

#Call the function execGUI and saves the result in the variable inputParametersList
set inputParametersList [execGUI "$pathToDevFolder\/DevFolder/$GUI_releaseVersionPath" "$pathToDevFolder\/DevFolder/inputParameters.txt"]



#Set the main variables according to the values contained in the variable inputParametersList
#if inputParametersList contains the word "CANCEL", it means that the user pressed cancel on the GUI
if {$inputParametersList == "CANCEL"} {
	quit
} else {
	#set the workspace directory path. Ex : "D:/Valentin/stacks"
	set workspace [lindex $inputParametersList 0]
	
	#set the name of the internal folder. Ex : "deconvolved"
	set internalFolder [lindex $inputParametersList 1]
	
	#set the path to the directory containing all the output folders. Ex : "D:/Valentin/outputs"
	set outputDirectoriesLocation [lindex $inputParametersList 2]
	
	#set the name of the new output folder to create in the folder outputDirectoriesLocation. Ex : "avizoOuput"
	set outputDirectoryName [lindex $inputParametersList 3]
	
	# #see report p 18 and p 36-37 to learn more about input workspace structure and output structure# #
	
	#set the voxel sizes (default : 0.104, 0.104 and 0.1)
	set voxelSizeX [lindex $inputParametersList 4]
	set voxelSizeY [lindex $inputParametersList 5]
	set voxelSizeZ [lindex $inputParametersList 6]
	
	#isMembrane = 0 if the user didn't check "membrane" on the GUI
	#isMembrane = 1 if the user checked "membrane" on the GUI
	set flags::isMembrane [lindex $inputParametersList 7]
	#Microscope channel corresponding to the membrane (561, 488, 405 or 642)
	set membraneChannel [lindex $inputParametersList 8]
	
	#isPaxilin = 0 if the user didn't check "paxilin" on the GUI
	#isPaxilin = 1 if the user checked "paxilin" on the GUI
	set flags::isPaxilin [lindex $inputParametersList 9]
	#Microscope channel corresponding to the paxilin (561, 488, 405 or 642)
	set paxilinChannel [lindex $inputParametersList 10]
	
	#isNucleus = 0 if the user didn't check "nucleus" on the GUI
	#isNucleus = 1 if the user checked "nucleus" on the GUI
	set flags::isNucleus [lindex $inputParametersList 11]
	#Microscope channel corresponding to the nucleus (561, 488, 405 or 642)
	set nucleusChannel [lindex $inputParametersList 12]
	
	#isScaffold = 0 if the user didn't check "scaffold" on the GUI
	#isScaffold = 1 if the user checked "scaffold" on the GUI
	set flags::isScaffold [lindex $inputParametersList 13]
	#Microscope channel corresponding to the scaffold (561, 488, 405 or 642)
	set scaffoldChannel [lindex $inputParametersList 14]

	# ################### OPTIONAL PARAMETERS SECTION ######################
	
	# Check if the user specified a particular image name to process or if he wants to process the entire workspace (Ex : B0)
	set image "cmle"
	if {[lindex $inputParametersList 15] != ""} {
		set image [lindex $inputParametersList 15]
	}
	
	#Set the lower hysteresis thresholding threshold for membrane (and scaffold) segmentation (default : 6)
	set membraneThreshold [lindex $inputParametersList 16]
	
	#set the size of the structuring element for the morphological closing (default : 1, corresponding to a 1*1*1 cube as a structuring element)
	set structuringElementSize [lindex $inputParametersList 17]
	
	#isUseNucleusForMembrane = 0 if the user didn't check the option on the GUI
	#isUseNucleusForMembrane = 1 if the user checked the option on the GUI
	set flags::isUseNucleusForMembrane [lindex $inputParametersList 18]
	
	#If the user wants the nucleus to be used in membrane processing AND want to process the membrane
	if {$flags::isUseNucleusForMembrane && $flags::isMembrane} {
		#set the value of flags::isNucleus to 1, regardless of its initial value defined above
		set flags::isNucleus 1
	}
	
	#isEllipsoidFit = 0 if the user didn't check the ellipsoid fit option on the GUI
	#isEllipsoidFit = 1 if the user checked the ellipsoid fit option on the GUI
	set flags::isEllipsoidFit [lindex $inputParametersList 19]

	# ################### ADVANCED PARAMETERS SECTION######################

	#set the path to the custom reference image to use for membrane pre-processing. the variable is empty if the user didn't specify a path on the GUI
	set customReferenceImageMembrane [lindex $inputParametersList 20]
	
	#set the path to the custom reference image to use for scaffold pre-processing. the variable is empty if the user didn't specify a path on the GUI
	set customReferenceImageScaffold [lindex $inputParametersList 21]
	
	#set the file format of the image stacks. This variable is used when a stack is saved when using the Avizo instruction "save" or "exportData"
	set fileFormat "3D Tiff"
}

# # Beginning of the processing workflow # #
#Record the starting time. This variable is just used to calculate the execution time of the macro.
set c1 [clock seconds]

#Create a list containing the names of the parameters that will be extracted from the processed image stacks. This variable is used when creating the global CSV files (report p 36-37).
set labelAnalysisParameters {Volume3d Breadth3d Area3d Shape_VA3d Thickness3d Anisotropy Perimeter FeretShape3d \
	Length3d Width3d BreadthOrientPhi BreadthOrientTheta LengthOrientPhi LengthOrientTheta WidthOrientPhi WidthOrientTheta \
	Area AreaFraction BorderVoxelCount CroftonPerimeter EqDiameter Euler3D IntegralMeanCurvature IntegralTotalCurvature \
	Orientation2Phi Orientation2Theta OrientationPhi OrientationTheta Volume Volume2 VoxelFaceArea Elongation \
	Flatness BoundingBoxDx BoundingBoxDy BoundingBoxDz BinMom2x BinMom2y BinMom2z BinMomxy \
	BinMomxz BinMomyz EigenVal1 EigenVal2 EigenVal3 EigenVec1X EigenVec1Y EigenVec1Z \
	EigenVec2X EigenVec2Y EigenVec2Z EigenVec3X EigenVec3Y EigenVec3Z ExtentMax1 ExtentMax2 \
	ExtentMax3 ExtentMin1 ExtentMin2 ExtentMin3 S/V a b c}

#Set the path to the output folder, by combining the two variables outputDirectoriesLocation and outputDirectoryName. Ex : "D:/Valentin/outputs/avizoOuput"
set outputPath [file join $outputDirectoriesLocation $outputDirectoryName]
#create the path. Ex : if "outputs" doesn't exist in "D:/Valentin", it creates the folder. Then if "avizoOuput" doesn't exist in "outputs", it creates the folder. Otherwise nothing happens.
file mkdir $outputPath


#Create the global CSV file for membrane stacks in the output folder, if membrane has been selected by the user. Ex : "D:/Valentin/outputs/avizoOutput/Membrane_561_shapeAnalysis_avizoOuput.csv"
if {$flags::isMembrane} {
	set membrane_shapeAnalysisCSVFile [file join $outputPath Membrane_$membraneChannel\_shapeAnalysis_$outputDirectoryName\.csv]
	#write in the global CSV file for membrane stacks the names contained in the list labelAnalysisParameters, so that they appear on the first line of the file.
	writeCSVFile $membrane_shapeAnalysisCSVFile [linsert $labelAnalysisParameters 0 Membrane_$membraneChannel] "," "overwrite"
}

#Create the global CSV file for nucleus stacks in the output folder, if nucleus has been selected by the user. Ex : "D:/Valentin/outputs/avizoOutput/Nucleus_405_shapeAnalysis_avizoOuput.csv"
if {$flags::isNucleus} {
	set nucleus_shapeAnalysisCSVFile [file join $outputPath Nucleus_$nucleusChannel\_shapeAnalysis_$outputDirectoryName\.csv]
	#write in the global CSV file for nucleus stacks the names contained in the list labelAnalysisParameters, so that they appear on the first line of the file.
	writeCSVFile $nucleus_shapeAnalysisCSVFile [linsert $labelAnalysisParameters 0 Nucleus_$nucleusChannel] "," "overwrite"
}

#Create the global CSV file for scaffold stacks in the output folder, if scaffold has been selected by the user. Ex : "D:/Valentin/outputs/avizoOutput/Scaffold_642_shapeAnalysis_avizoOuput.csv"
if {$flags::isScaffold} {
	set scaffold_shapeAnalysisCSVFile [file join $outputPath Scaffold_$scaffoldChannel\_shapeAnalysis_$outputDirectoryName\.csv]
	#write in the global CSV file for scaffold stacks the names contained in the list labelAnalysisParameters, so that they appear on the first line of the file.
	writeCSVFile $scaffold_shapeAnalysisCSVFile [linsert $labelAnalysisParameters 0 Scaffold_$scaffoldChannel] "," "overwrite"
}


#Set the reference images paths. If the user didn't specify a custom path in the GUI, they are set to default
set referenceImages [referenceImagesSetup $pathToDevFolder $customReferenceImageMembrane $customReferenceImageScaffold]
set referenceImageMembrane [lindex $referenceImages 0]
set referenceImageScaffold [lindex $referenceImages 1]

#Set the list of all cell folders in the workspace
set cellFolderList [getDirectoryContent $workspace "tail"]

#For each folder in cellFolderList
set cellFolderListLength [llength $cellFolderList]
for {set j 0} {$j<$cellFolderListLength} {incr j} {
	set cellFolder [lindex $cellFolderList $j]
	#Prepare an error flag.
	set errorFlag 0
	#Check whether the user decided to process only one particular cell folder (Ex : "B0") or the entire workspace.
	if {$image == "cmle" || $image == $cellFolder} {
		#Check if the internal folder exists, and if it is not empty.
		if {![isDirectoryOrFileExist [file join $workspace $cellFolder $internalFolder]] || [isDirectoryEmpty [file join $workspace $cellFolder $internalFolder]]} {
			#set the errorFlag to 1, to say that there is a problem with the current cell folder.
			set errorFlag 1
		#If everything is fine, get a list of the image stacks contained in the internal folder.
		} else {
			set imageStackPathList [getFilesInDirectory [file join $workspace $cellFolder $internalFolder] ".tif" "path"]
		}
		#If the errorFlag is equal to 0 (no problem with the current cell folder).
		if {!$errorFlag} {
			#Set the path to the output cell folder. Ex : "D:/Valentin/outputs/avizoOuput/B0_avizoOuput"
			set cellFolderOutputPath [file join $outputPath $cellFolder\_$outputDirectoryName]
			#Create all the output folders in the output cell folder, according to output structure (report p 36-37)
			file mkdir [file join $cellFolderOutputPath segmented]
			file mkdir [file join $cellFolderOutputPath boundary]
			file mkdir [file join $cellFolderOutputPath csvFiles]
			file mkdir [file join $cellFolderOutputPath hxFiles]
			file mkdir [file join $cellFolderOutputPath verification]
			
			#If nucleus is selected
			if {$flags::isNucleus} {
				#Get the path to the nucleus stack in the list imageStackPathList
				set nucleusStackPath [getElementRegexp $imageStackPathList $nucleusChannel]
				#This foreach structure is here in case multiple nucleus stacks are found in the list. It also prevents errors in case no nucleus stack is found.
				foreach path $nucleusStackPath {
					nucleus $path $cellFolderOutputPath $fileFormat $structuringElementSize $nucleus_shapeAnalysisCSVFile $voxelSizeX $voxelSizeY $voxelSizeZ
				}
			}
			#If membrane is selected
			if {$flags::isMembrane} {
				#Get the path to the membrane stack in the list imageStackPathList
				set membraneStackPath [getElementRegexp $imageStackPathList $membraneChannel]
				#This foreach structure is here in case multiple membrane stacks are found in the list. It also prevents errors in case no nucleus stack is found.
				foreach path $membraneStackPath {
					membrane $path $cellFolderOutputPath $fileFormat $referenceImageMembrane $membraneThreshold $structuringElementSize $membrane_shapeAnalysisCSVFile $voxelSizeX $voxelSizeY $voxelSizeZ
				}
			}
			#If scaffold is selected
			if {$flags::isScaffold} {
				#Get the path to the scaffold stack in the list imageStackPathList
				set scaffoldStackPath [getElementRegexp $imageStackPathList $scaffoldChannel]
				#This foreach structure is here in case multiple scaffold stacks are found in the list. It also prevents errors in case no nucleus stack is found.
				foreach path $scaffoldStackPath {
					scaffold $path $cellFolderOutputPath $fileFormat $referenceImageScaffold $membraneThreshold $scaffold_shapeAnalysisCSVFile $voxelSizeX $voxelSizeY $voxelSizeZ
				}
			}
			#If paxilin is selected
			if {$flags::isPaxilin} {
				#Get the path to the paxilin stack in the list imageStackPathList
				set paxilinStackPath [getElementRegexp $imageStackPathList $paxilinChannel]
				#This foreach structure is here in case multiple paxilin stacks are found in the list. It also prevents errors in case no nucleus stack is found.
				foreach path $paxilinStackPath {
					paxilin $path $cellFolderOutputPath $fileFormat $voxelSizeX $voxelSizeY $voxelSizeZ
				}
			}
		}
	}
}

set c2 [clock seconds]
set diff [expr $c2 - $c1]
echo "execution time (s) :" $diff s
echo "execution time (min) :" [expr $diff/60] min
echo "execution time (h) :" [expr $diff/3600] h